<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Bán Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .tab { display: none; }
        .active { display: block; }
        .card { margin-top: 20px; }
        img.product-img { max-width: 100px; height: auto; }
        .sortable { cursor: pointer; }
        .sort-icon { margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Hệ Thống Quản Lý Bán Hàng</h1>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#productsTab" type="button" role="tab">Quản Lý Mặt Hàng</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#salesTab" type="button" role="tab">Quản Lý Bán Hàng</button>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="productsTab" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title">Quản Lý Mặt Hàng</h2>
                        <form id="productForm">
                            <input type="hidden" id="productId">
                            <div class="mb-3">
                                <label class="form-label">Tên Mặt Hàng:</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Giá Nhập:</label>
                                <input type="number" class="form-control" id="importPrice" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Giá Bán:</label>
                                <input type="number" class="form-control" id="productPrice" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Số Lượng:</label>
                                <input type="number" class="form-control" id="productQuantity" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hình Ảnh:</label>
                                <input type="file" class="form-control" id="productImage" accept="image/*">
                                <img id="previewImage" class="product-img mt-2" style="display: none;">
                            </div>
                            <button type="button" class="btn btn-primary" id="addProduct">Thêm/Sửa</button>
                            <button type="button" class="btn btn-secondary" id="clearProductForm">Xóa Form</button>
                        </form>
                    </div>
                </div>
                <div class="mt-3">
                    <input type="text" id="searchProduct" class="form-control" placeholder="Tìm kiếm theo tên sản phẩm...">
                </div>
                <table class="table table-striped mt-4" id="productsTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="id">ID<span class="sort-icon"></span></th>
                            <th class="sortable" data-column="name">Tên<span class="sort-icon"></span></th>
                            <th class="sortable" data-column="importPrice">Giá Nhập<span class="sort-icon"></span></th>
                            <th class="sortable" data-column="price">Giá Bán<span class="sort-icon"></span></th>
                            <th class="sortable" data-column="quantity">Số Lượng<span class="sort-icon"></span></th>
                            <th>Hình Ảnh</th>
                            <th>Hành Động</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="salesTab" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title">Quản Lý Bán Hàng</h2>
                        <form id="saleForm">
                            <input type="hidden" id="saleId">
                            <div class="mb-3">
                                <label class="form-label">Ngày Bán:</label>
                                <input type="date" class="form-control" id="saleDate" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Chọn Mặt Hàng:</label>
                                    <select class="form-select" id="saleProduct" required></select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Số Lượng:</label>
                                    <input type="number" class="form-control" id="saleQuantity" min="1" required>
                                </div>
                                <div class="col-md-3 mb-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-success" id="addToCart">Thêm Vào Giỏ</button>
                                </div>
                            </div>
                            <table class="table table-bordered" id="cartTable">
                                <thead><tr><th>Tên</th><th>Giá</th><th>Số Lượng</th><th>Tổng</th><th>Xóa</th></tr></thead>
                                <tbody></tbody>
                            </table>
                            <p class="fw-bold">Tổng Tiền: <span id="totalAmount">0</span></p>
                            <button type="button" class="btn btn-primary" id="saveSale">Lưu Đơn Hàng</button>
                            <button type="button" class="btn btn-secondary" id="clearSaleForm">Xóa Form</button>
                        </form>
                    </div>
                </div>
                <h3 class="mt-4">Lịch Sử Đơn Hàng</h3>
                <table class="table table-striped" id="salesTable">
                    <thead><tr><th>ID</th><th>Ngày</th><th>Tổng Tiền</th><th>Chi Tiết</th><th>Xóa</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="mt-4 text-center">
            <button class="btn btn-info" id="exportData">Xuất Dữ Liệu Ra File Text</button>
            <button class="btn btn-info" id="importData">Nhập Dữ Liệu Từ File Text</button>
            <input type="file" id="fileInput" style="display: none;">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let products = [];
        let sales = [];
        let currentCart = [];
        let nextProductId = 1;
        let nextSaleId = 1;
        let sortColumn = 'id';
        let sortDirection = 'asc';

        // Load data from localStorage if available
        if (localStorage.getItem('products')) {
            products = JSON.parse(localStorage.getItem('products'));
            nextProductId = Math.max(...products.map(p => p.id)) + 1;
        }
        if (localStorage.getItem('sales')) {
            sales = JSON.parse(localStorage.getItem('sales'));
            nextSaleId = Math.max(...sales.map(s => s.id)) + 1;
        }

        // Product Management
        $('#addProduct').click(function() {
            const id = $('#productId').val() || nextProductId++;
            const name = $('#productName').val();
            const importPrice = parseFloat($('#importPrice').val());
            const price = parseFloat($('#productPrice').val());
            const quantity = parseInt($('#productQuantity').val());
            const imageFile = $('#productImage')[0].files[0];
            let image = '';

            if (name && importPrice >= 0 && price >= 0 && quantity >= 0) {
                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        image = e.target.result;
                        saveProduct(id, name, importPrice, price, quantity, image);
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    const existingImage = products.find(p => p.id == id)?.image || '';
                    saveProduct(id, name, importPrice, price, quantity, existingImage);
                }
            }
        });

        function saveProduct(id, name, importPrice, price, quantity, image) {
            const existing = products.find(p => p.id == id);
            if (existing) {
                existing.name = name;
                existing.importPrice = importPrice;
                existing.price = price;
                existing.quantity = quantity;
                existing.image = image;
            } else {
                products.push({ id, name, importPrice, price, quantity, image });
            }
            saveToLocal();
            renderProducts();
            clearProductForm();
        }

        function renderProducts() {
            const search = $('#searchProduct').val().toLowerCase();
            let displayedProducts = products.filter(p => p.name.toLowerCase().includes(search));

            if (sortColumn) {
                displayedProducts.sort((a, b) => {
                    let valA = a[sortColumn];
                    let valB = b[sortColumn];
                    if (typeof valA === 'string') {
                        return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    } else {
                        return sortDirection === 'asc' ? valA - valB : valB - valA;
                    }
                });
            }

            $('#productsTable tbody').empty();
            displayedProducts.forEach(p => {
                const imgSrc = p.image ? `<img src="${p.image}" class="product-img">` : 'Không có';
                $('#productsTable tbody').append(`
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${p.importPrice}</td>
                        <td>${p.price}</td>
                        <td>${p.quantity}</td>
                        <td>${imgSrc}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editProduct(${p.id})">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">Xóa</button>
                        </td>
                    </tr>
                `);
            });
            updateSortIcons();
            renderProductOptions();
        }

        function updateSortIcons() {
            $('.sort-icon').text('');
            if (sortColumn) {
                const icon = sortDirection === 'asc' ? '↑' : '↓';
                $(`.sortable[data-column="${sortColumn}"] .sort-icon`).text(icon);
            }
        }

        $('.sortable').click(function() {
            const column = $(this).data('column');
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderProducts();
        });

        $('#searchProduct').keyup(function() {
            renderProducts();
        });

        function editProduct(id) {
            const p = products.find(p => p.id == id);
            $('#productId').val(p.id);
            $('#productName').val(p.name);
            $('#importPrice').val(p.importPrice);
            $('#productPrice').val(p.price);
            $('#productQuantity').val(p.quantity);
            if (p.image) {
                $('#previewImage').attr('src', p.image).show();
            } else {
                $('#previewImage').hide();
            }
        }

        function deleteProduct(id) {
            products = products.filter(p => p.id != id);
            saveToLocal();
            renderProducts();
        }

        $('#clearProductForm').click(clearProductForm);
        function clearProductForm() {
            $('#productForm')[0].reset();
            $('#productId').val('');
            $('#previewImage').hide();
            $('#productImage').val('');
        }

        $('#productImage').change(function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#previewImage').attr('src', e.target.result).show();
                };
                reader.readAsDataURL(file);
            }
        });

        // Sale Management
        function renderProductOptions() {
            $('#saleProduct').empty();
            products.forEach(p => {
                $('#saleProduct').append(`<option value="${p.id}">${p.name} (Giá: ${p.price}, Còn: ${p.quantity})</option>`);
            });
        }

        $('#addToCart').click(function() {
            const productId = $('#saleProduct').val();
            const quantity = parseInt($('#saleQuantity').val());
            const product = products.find(p => p.id == productId);

            if (product && quantity > 0 && quantity <= product.quantity) {
                currentCart.push({ productId, name: product.name, price: product.price, quantity });
                renderCart();
                $('#saleQuantity').val('');
            } else {
                alert('Số lượng không hợp lệ hoặc hết hàng!');
            }
        });

        function renderCart() {
            $('#cartTable tbody').empty();
            let total = 0;
            currentCart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                $('#cartTable tbody').append(`
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.price}</td>
                        <td>${item.quantity}</td>
                        <td>${subtotal}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">Xóa</button></td>
                    </tr>
                `);
            });
            $('#totalAmount').text(total);
        }

        function removeFromCart(index) {
            currentCart.splice(index, 1);
            renderCart();
        }

        $('#saveSale').click(function() {
            if (currentCart.length > 0) {
                const id = $('#saleId').val() || nextSaleId++;
                const date = $('#saleDate').val();
                const total = parseFloat($('#totalAmount').text());
                sales.push({ id, date, items: [...currentCart], total });
                // Update product quantities
                currentCart.forEach(item => {
                    const p = products.find(p => p.id == item.productId);
                    p.quantity -= item.quantity;
                });
                saveToLocal();
                renderSales();
                renderProducts();
                clearSaleForm();
            }
        });

        function renderSales() {
            $('#salesTable tbody').empty();
            sales.forEach(s => {
                $('#salesTable tbody').append(`
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.date}</td>
                        <td>${s.total}</td>
                        <td><button class="btn btn-sm btn-info" onclick="viewSaleDetails(${s.id})">Xem</button></td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteSale(${s.id})">Xóa</button></td>
                    </tr>
                `);
            });
        }

        function viewSaleDetails(id) {
            const s = sales.find(s => s.id == id);
            alert(`Chi Tiết Đơn Hàng ${id}:\n${s.items.map(item => `${item.name} x${item.quantity} = ${item.price * item.quantity}`).join('\n')}\nTổng: ${s.total}`);
        }

        function deleteSale(id) {
            const s = sales.find(s => s.id == id);
            // Restore quantities
            s.items.forEach(item => {
                const p = products.find(p => p.id == item.productId);
                p.quantity += item.quantity;
            });
            sales = sales.filter(s => s.id != id);
            saveToLocal();
            renderSales();
            renderProducts();
        }

        $('#clearSaleForm').click(clearSaleForm);
        function clearSaleForm() {
            $('#saleForm')[0].reset();
            $('#saleId').val('');
            currentCart = [];
            renderCart();
        }

        // Data Export/Import
        $('#exportData').click(function() {
            const data = { products, sales };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.txt';
            a.click();
            URL.revokeObjectURL(url);
        });

        $('#importData').click(function() {
            $('#fileInput').click();
        });

        $('#fileInput').change(function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        products = data.products || [];
                        sales = data.sales || [];
                        nextProductId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                        nextSaleId = sales.length > 0 ? Math.max(...sales.map(s => s.id)) + 1 : 1;
                        saveToLocal();
                        renderProducts();
                        renderSales();
                        alert('Dữ liệu đã được nhập thành công!');
                    } catch (err) {
                        alert('Lỗi khi nhập dữ liệu: ' + err.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        function saveToLocal() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('sales', JSON.stringify(sales));
        }

        // Initial render
        renderProducts();
        renderSales();
    </script>
</body>
</html>
