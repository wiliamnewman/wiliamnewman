<!doctype html>
<html lang="vi">
 <head>
  <meta charset="UTF-8">
  <title>Qu·∫£n L√Ω B√°n H√†ng Offline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script><!-- Canva SDKs -->
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
    }
    /* ·∫®n scrollbar x·∫•u tr√™n m·ªôt s·ªë tr√¨nh duy·ªát */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* Scrollbar ƒë·∫πp cho b·∫£ng */
    .table-scroll::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    .table-scroll::-webkit-scrollbar-track {
      background: #0f172a;
    }
    .table-scroll::-webkit-scrollbar-thumb {
      background: #0ea5e9;
      border-radius: 4px;
    }
    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: #0284c7;
    }
    /* C·ªôt checkbox c·ªë ƒë·ªãnh b√™n tr√°i */
    .sticky-checkbox {
      position: sticky;
      left: 0;
      z-index: 10;
      background: inherit;
    }
    /* H√†ng ti√™u ƒë·ªÅ c·ªë ƒë·ªãnh */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: inherit;
    }
    /* Context menu custom */
    .context-menu {
      position: absolute;
      z-index: 50;
    }
    /* Modal ·∫£nh transform m∆∞·ª£t */
    .image-transform {
      transition: transform 0.2s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="w-full h-full bg-sky-950 text-slate-100 font-sans">
  <header class="w-full">
   <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
    <h1 id="appTitle" class="text-2xl font-bold tracking-tight text-white">Qu·∫£n l√Ω b√°n h√†ng</h1>
    <div class="flex flex-wrap gap-2"><button id="btnBackup" class="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-sky-950 focus:ring-emerald-300"> Backup </button> <label for="inputRestore" class="px-3 py-1.5 rounded-lg bg-amber-500 hover:bg-amber-400 text-sm font-semibold cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-sky-950 focus:ring-amber-300"> Kh√¥i ph·ª•c </label> <input id="inputRestore" type="file" accept=".json" class="hidden"> <button id="btnPrint" class="px-3 py-1.5 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-sky-950 focus:ring-indigo-300"> In danh s√°ch </button>
    </div>
   </div>
  </header>
  <main class="w-full">
   <div class="max-w-6xl mx-auto px-4 pb-4 flex flex-col gap-4 h-full"><!-- Tabs -->
    <nav class="flex border-b border-sky-700 text-sm mt-1" aria-label="Chuy·ªÉn tab"><button data-tab="dashboard" class="tab-btn px-4 py-2 -mb-px border-b-2 border-transparent text-slate-200 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300"> Dashboard </button> <button data-tab="products" class="tab-btn px-4 py-2 -mb-px border-b-2 border-emerald-400 text-white font-semibold focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300"> S·∫£n ph·∫©m </button> <button data-tab="sell" class="tab-btn px-4 py-2 -mb-px border-b-2 border-transparent text-slate-200 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300"> B√°n h√†ng </button> <button data-tab="columns" class="tab-btn px-4 py-2 -mb-px border-b-2 border-transparent text-slate-200 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300"> C·ªôt </button>
    </nav><!-- DASHBOARD -->
    <section id="tab-dashboard" class="hidden">
     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"><!-- T·ªïng s·ªë sp -->
      <div class="rounded-xl p-4 bg-gradient-to-br from-emerald-500 to-teal-400 text-slate-900 flex items-center gap-3">
       <div class="flex-shrink-0 w-10 h-10 rounded-full bg-white/80 flex items-center justify-center"><span class="text-xl">üì¶</span>
       </div>
       <div>
        <h2 class="text-xs font-semibold uppercase tracking-wide">T·ªïng s·∫£n ph·∫©m</h2>
        <p id="dashTotalProducts" class="text-2xl font-bold">0</p>
       </div>
      </div><!-- T·ªïng gi√° tr·ªã -->
      <div class="rounded-xl p-4 bg-gradient-to-br from-indigo-500 to-sky-400 text-slate-900 flex items-center gap-3">
       <div class="flex-shrink-0 w-10 h-10 rounded-full bg-white/80 flex items-center justify-center"><span class="text-xl">üí∞</span>
       </div>
       <div>
        <h2 class="text-xs font-semibold uppercase tracking-wide">T·ªïng gi√° tr·ªã</h2>
        <p id="dashTotalValue" class="text-2xl font-bold">0</p>
       </div>
      </div><!-- T·ªïng t·ªìn kho -->
      <div class="rounded-xl p-4 bg-gradient-to-br from-amber-500 to-orange-400 text-slate-900 flex items-center gap-3">
       <div class="flex-shrink-0 w-10 h-10 rounded-full bg-white/80 flex items-center justify-center"><span class="text-xl">üìä</span>
       </div>
       <div>
        <h2 class="text-xs font-semibold uppercase tracking-wide">T·ªïng t·ªìn kho</h2>
        <p id="dashTotalStock" class="text-2xl font-bold">0</p>
       </div>
      </div><!-- S·∫£n ph·∫©m m·ªõi -->
      <div class="rounded-xl p-4 bg-gradient-to-br from-rose-500 to-pink-400 text-slate-900 flex items-center gap-3">
       <div class="flex-shrink-0 w-10 h-10 rounded-full bg-white/80 flex items-center justify-center"><span class="text-xl">üÜï</span>
       </div>
       <div>
        <h2 class="text-xs font-semibold uppercase tracking-wide">SP m·ªõi 7 ng√†y</h2>
        <p id="dashNewProducts" class="text-2xl font-bold">0</p>
       </div>
      </div>
     </div>
     <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4"><!-- C·∫£nh b√°o t·ªìn kho -->
      <div class="lg:col-span-1 rounded-xl bg-sky-900/60 border border-sky-700 p-3">
       <h2 class="text-sm font-semibold mb-2 flex items-center gap-2"><span>‚ö†</span> C·∫£nh b√°o t·ªìn kho</h2>
       <div class="space-y-2 max-h-[60%] overflow-y-auto no-scrollbar" id="dashWarnings">
        <p class="text-xs text-slate-300">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>
       </div>
      </div><!-- Top 10 gi√° tr·ªã cao -->
      <div class="lg:col-span-2 rounded-xl bg-sky-900/60 border border-sky-700 p-3">
       <h2 class="text-sm font-semibold mb-2">Top 10 s·∫£n ph·∫©m gi√° tr·ªã cao</h2>
       <div class="overflow-x-auto no-scrollbar">
        <table class="min-w-full text-xs">
         <thead>
          <tr class="text-left text-slate-300 border-b border-sky-700">
           <th class="py-1 pr-2">#</th>
           <th class="py-1 pr-2">T√™n</th>
           <th class="py-1 pr-2">Gi√°</th>
           <th class="py-1 pr-2">SL</th>
           <th class="py-1 pr-2">Gi√° tr·ªã</th>
          </tr>
         </thead>
         <tbody id="dashTopProducts">
          <tr>
           <td colspan="5" class="py-2 text-center text-slate-300">Ch∆∞a c√≥ d·ªØ li·ªáu.</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </section><!-- PRODUCTS -->
    <section id="tab-products" class="flex flex-col gap-3"><!-- Thanh c√¥ng c·ª• -->
     <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex flex-wrap gap-2"><button id="btnAddProduct" class="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-xs sm:text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-sky-950 focus:ring-emerald-300"> + Th√™m s·∫£n ph·∫©m </button> <button id="btnEditSelected" class="px-3 py-1.5 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-xs sm:text-sm font-semibold disabled:opacity-40"> S·ª≠a h√†ng lo·∫°t </button> <button id="btnCloneSelected" class="px-3 py-1.5 rounded-lg bg-sky-500 hover:bg-sky-400 text-xs sm:text-sm font-semibold disabled:opacity-40"> Nh√¢n b·∫£n </button> <button id="btnDeleteSelected" class="px-3 py-1.5 rounded-lg bg-rose-500 hover:bg-rose-400 text-xs sm:text-sm font-semibold disabled:opacity-40"> X√≥a </button>
      </div>
      <div class="flex flex-wrap gap-2"><select id="selectStatusFilter" class="px-2 py-1 rounded-md bg-sky-900 border border-sky-700 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-300"> <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option> <option value="in">C√≤n h√†ng</option> <option value="low">S·∫Øp h·∫øt</option> <option value="out">H·∫øt h√†ng</option> </select> <select id="selectSearchColumn" class="px-2 py-1 rounded-md bg-sky-900 border border-sky-700 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-300"> <option value="all">T√¨m trong t·∫•t c·∫£ c·ªôt</option> </select> <input id="inputSearch" type="text" class="px-2 py-1 rounded-md bg-sky-900 border border-sky-700 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="T·ª´ kh√≥a...">
      </div>
     </div><!-- Xu·∫•t/Nh·∫≠p -->
     <div class="flex flex-wrap gap-2 items-center text-xs"><span class="text-slate-300 mr-1">Xu·∫•t:</span> <button data-export="txt" class="btn-export px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">TXT</button> <button data-export="json" class="btn-export px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">JSON</button> <button data-export="csv" class="btn-export px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">CSV</button> <button data-export="html" class="btn-export px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">HTML</button> <button data-export="xml" class="btn-export px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">XML</button> <span class="text-slate-300 ml-3 mr-1">Nh·∫≠p:</span> <label for="inputImport" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 cursor-pointer"> Ch·ªçn file </label> <input id="inputImport" type="file" accept=".txt,.json,.csv,.xml,.html" class="hidden">
      <div class="flex-1 min-w-[150px] max-w-xs h-2 bg-slate-800 rounded overflow-hidden">
       <div id="importProgressBar" class="h-full bg-emerald-400" style="width:0%"></div>
      </div><span id="importStatus" class="text-slate-300"></span>
     </div><!-- Th√¥ng tin ch·ªçn & ph√¢n trang -->
     <div class="flex flex-wrap items-center justify-between gap-2 text-xs">
      <div>
       ƒê√£ ch·ªçn: <span id="selectedCount" class="font-semibold">0</span> s·∫£n ph·∫©m
      </div>
      <div class="flex items-center gap-2"><label for="pageSize" class="text-slate-300">Hi·ªÉn th·ªã:</label> <select id="pageSize" class="px-2 py-1 rounded-md bg-sky-900 border border-sky-700 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-300"> <option value="10">10</option> <option value="25">25</option> <option value="50">50</option> <option value="100">100</option> <option value="all">T·∫•t c·∫£</option> </select>
       <div class="flex items-center gap-1"><button id="btnPrevPage" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">&lt;</button> <span id="pageInfo">1 / 1</span> <button id="btnNextPage" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">&gt;</button>
       </div>
      </div>
     </div><!-- B·∫£ng s·∫£n ph·∫©m -->
     <div class="relative rounded-xl bg-sky-900/60 border border-sky-700 overflow-hidden">
      <div class="overflow-x-auto overflow-y-auto max-h-[600px] table-scroll">
       <table class="text-xs" style="min-width: 100%; width: max-content;" aria-label="Danh s√°ch s·∫£n ph·∫©m">
        <thead class="bg-sky-900 sticky-header">
         <tr id="productHeaderRow"><!-- Checkbox select all -->
          <th class="px-2 py-2 border-b border-sky-700 w-8"><input id="chkSelectAll" type="checkbox" class="w-4 h-4" aria-label="Ch·ªçn t·∫•t c·∫£"></th><!-- C√°c c·ªôt ƒë·ªông s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
         </tr>
        </thead>
        <tbody id="productBody"><!-- H√†ng d·ªØ li·ªáu -->
        </tbody>
       </table>
      </div>
      <div id="emptyState" class="py-6 text-center text-slate-300 text-xs">
       Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. H√£y nh·∫•n "Th√™m s·∫£n ph·∫©m".
      </div>
     </div><!-- Context menu chu·ªôt ph·∫£i -->
     <div id="contextMenu" class="context-menu hidden bg-slate-900 border border-slate-700 rounded-md shadow-lg text-xs"><button data-action="edit" class="block w-full text-left px-3 py-2 hover:bg-slate-800">S·ª≠a</button> <button data-action="clone" class="block w-full text-left px-3 py-2 hover:bg-slate-800">Nh√¢n b·∫£n</button> <button data-action="delete" class="block w-full text-left px-3 py-2 hover:bg-slate-800">X√≥a</button> <button data-action="export" class="block w-full text-left px-3 py-2 hover:bg-slate-800">Xu·∫•t (JSON)</button>
     </div>
    </section><!-- B√ÅN H√ÄNG -->
    <section id="tab-sell" class="hidden">
     <div class="grid grid-cols-1 lg:grid-cols-3 gap-4"><!-- Danh s√°ch s·∫£n ph·∫©m -->
      <div class="lg:col-span-2 rounded-xl bg-sky-900/60 border border-sky-700 p-3">
       <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold">Ch·ªçn s·∫£n ph·∫©m</h2><input id="sellSearch" type="text" placeholder="T√¨m s·∫£n ph·∫©m..." class="px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs w-48">
       </div>
       <div class="max-h-[500px] overflow-y-auto no-scrollbar">
        <div id="sellProductList" class="grid grid-cols-1 sm:grid-cols-2 gap-2"><!-- Danh s√°ch s·∫£n ph·∫©m -->
        </div>
       </div>
      </div><!-- Gi·ªè h√†ng -->
      <div class="lg:col-span-1 rounded-xl bg-sky-900/60 border border-sky-700 p-3 flex flex-col">
       <h2 class="text-sm font-semibold mb-3">Gi·ªè h√†ng</h2>
       <div class="mb-3"><label for="customerName" class="block text-xs font-semibold mb-1">T√™n kh√°ch h√†ng</label> <input id="customerName" type="text" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng (t√πy ch·ªçn)" class="w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs">
       </div>
       <div class="flex-1 overflow-y-auto no-scrollbar mb-3">
        <div id="cartItems" class="space-y-2">
         <p class="text-xs text-slate-300 text-center py-4">Gi·ªè h√†ng tr·ªëng</p>
        </div>
       </div>
       <div class="border-t border-sky-700 pt-3 space-y-2">
        <div class="flex justify-between text-sm"><span>T·∫°m t√≠nh:</span> <span id="cartSubtotal" class="font-semibold">0 ‚Ç´</span>
        </div>
        <div class="flex justify-between text-sm"><span>Gi·∫£m gi√°:</span>
         <div class="flex items-center gap-1"><input id="discountInput" type="number" min="0" max="100" value="0" class="w-16 px-1 py-0.5 rounded bg-sky-950 border border-sky-700 text-xs text-right"> <span>%</span>
         </div>
        </div>
        <div class="flex justify-between text-lg font-bold border-t border-sky-700 pt-2"><span>T·ªïng c·ªông:</span> <span id="cartTotal" class="text-emerald-400">0 ‚Ç´</span>
        </div>
        <div class="flex gap-2 mt-3"><button id="btnClearCart" class="flex-1 px-3 py-2 rounded-lg bg-rose-500 hover:bg-rose-400 text-xs font-semibold"> X√≥a gi·ªè </button> <button id="btnCheckout" class="flex-1 px-3 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-xs font-semibold"> Thanh to√°n </button>
        </div>
       </div>
      </div>
     </div>
    </section><!-- COLUMNS -->
    <section id="tab-columns" class="hidden flex flex-col gap-3">
     <div class="flex flex-wrap items-center justify-between gap-2"><button id="btnAddColumn" class="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-xs sm:text-sm font-semibold"> + Th√™m c·ªôt </button>
      <p class="text-xs text-slate-300">Checkbox ch·ªçn s·∫£n ph·∫©m l√† c·ªôt h·ªá th·ªëng ·∫©n, kh√¥ng hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
     </div>
     <div class="rounded-xl bg-sky-900/60 border border-sky-700 overflow-hidden">
      <div class="overflow-x-auto overflow-y-auto max-h-[500px] table-scroll">
       <table class="text-xs" style="min-width: 100%; width: max-content;">
        <thead class="bg-sky-900 sticky top-0 z-10">
         <tr>
          <th class="px-2 py-2 border-b border-sky-700 bg-sky-900">Th·ª© t·ª±</th>
          <th class="px-2 py-2 border-b border-sky-700 bg-sky-900">T√™n c·ªôt</th>
          <th class="px-2 py-2 border-b border-sky-700 bg-sky-900">Lo·∫°i</th>
          <th class="px-2 py-2 border-b border-sky-700 bg-sky-900">Gi√° tr·ªã m·∫∑c ƒë·ªãnh</th>
          <th class="px-2 py-2 border-b border-sky-700 bg-sky-900">H√†nh ƒë·ªông</th>
         </tr>
        </thead>
        <tbody id="columnBody"><!-- H√†ng c·ªôt -->
        </tbody>
       </table>
      </div>
     </div>
    </section>
   </div>
  </main><!-- MODAL FORM S·∫¢N PH·∫®M -->
  <div id="productModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40 hidden">
   <div class="bg-sky-900 rounded-xl border border-sky-600 w-full max-w-xl max-h-[90%] overflow-y-auto no-scrollbar p-4">
    <div class="flex items-center justify-between mb-3">
     <h2 id="productModalTitle" class="text-lg font-semibold">Th√™m s·∫£n ph·∫©m</h2><button id="btnCloseProductModal" class="text-slate-300 hover:text-white text-xl leading-none">√ó</button>
    </div>
    <form id="productForm" class="space-y-3">
     <div id="productFormFields" class="space-y-3"><!-- Tr∆∞·ªùng ƒë·ªông theo c·ªôt -->
     </div><!-- Upload ·∫£nh -->
     <div><label for="inputImages" class="block text-xs font-semibold mb-1">H√¨nh ·∫£nh</label> <input id="inputImages" type="file" multiple accept="image/*" class="w-full text-xs bg-sky-950 border border-sky-700 rounded-md p-1.5">
      <div id="imagePreviewContainer" class="mt-2 flex flex-wrap gap-2"></div>
     </div>
     <div class="flex items-center justify-between pt-2">
      <div class="text-xs text-slate-300">
       Tr·∫°ng th√°i t·ªìn kho s·∫Ω t·ª± ƒë·ªông t√≠nh theo s·ªë l∆∞·ª£ng.
      </div>
      <div class="flex gap-2"><button type="button" id="btnCancelProduct" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs font-semibold"> H·ªßy </button> <button type="submit" id="btnSaveProduct" class="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-xs font-semibold"> L∆∞u </button>
      </div>
     </div>
    </form>
   </div>
  </div><!-- MODAL ·∫¢NH -->
  <div id="imageModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
   <div class="relative w-full h-full flex items-center justify-center">
    <div class="absolute top-3 right-3 flex gap-2"><button id="btnZoomOut" class="px-2 py-1 bg-slate-800 text-xs rounded">-</button> <button id="btnZoomIn" class="px-2 py-1 bg-slate-800 text-xs rounded">+</button> <button id="btnZoomReset" class="px-2 py-1 bg-slate-800 text-xs rounded">100%</button> <button id="btnRotate" class="px-2 py-1 bg-slate-800 text-xs rounded">‚Üª</button> <button id="btnCloseImageModal" class="px-2 py-1 bg-rose-600 text-xs rounded">X</button>
    </div>
    <div class="absolute bottom-3 left-1/2 -translate-x-1/2 text-xs text-slate-200 bg-black/50 px-3 py-1 rounded-full">
     Zoom: <span id="zoomPercent">100%</span> | <span id="dragHint" class="opacity-60">K√©o ƒë·ªÉ di chuy·ªÉn</span>
    </div>
    <div id="imageContainer" class="max-w-[90%] max-h-[90%] overflow-hidden flex items-center justify-center cursor-grab active:cursor-grabbing"><img id="imageModalImg" src="" alt="Xem ·∫£nh" class="image-transform max-w-full max-h-full pointer-events-none">
    </div>
   </div>
  </div><!-- ·∫®n in --> <iframe id="printFrame" class="hidden"></iframe>
  <script>
    // ================= C·∫§U H√åNH CANVA ELEMENT SDK =====================
    const defaultConfig = {
      app_title: "Qu·∫£n l√Ω b√°n h√†ng",
      product_tab_title: "S·∫£n ph·∫©m",
      column_tab_title: "C·ªôt",
      dashboard_tab_title: "Dashboard",
      background_color: "#0f172a",   // BACKGROUND
      surface_color: "#020617",      // SECONDARY_SURFACE
      text_color: "#e2e8f0",         // TEXT
      primary_color: "#22c55e",      // PRIMARY_ACTION
      secondary_action_color: "#1e293b", // SECONDARY_ACTION
      font_family: "system-ui",
      font_size: 14
    };

    function applyConfigToUI(config) {
      const cfg = Object.assign({}, defaultConfig, config || {});
      const baseSize = cfg.font_size || defaultConfig.font_size;
      const fontStack = (cfg.font_family || defaultConfig.font_family) + ", system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";

      // M√†u n·ªÅn t·ªïng th·ªÉ
      document.body.style.backgroundColor = cfg.background_color;
      // B·ªÅ m·∫∑t ch√≠nh (c√°c kh·ªëi surface ch√≠nh)
      const surfaces = document.querySelectorAll(".bg-sky-900\\/60, .bg-sky-900");
      surfaces.forEach(el => {
        el.style.backgroundColor = cfg.surface_color;
      });

      // M√†u ch·ªØ
      document.body.style.color = cfg.text_color;

      // N√∫t primary
      const primaryButtons = document.querySelectorAll("#btnAddProduct, #btnBackup, #btnSaveProduct");
      primaryButtons.forEach(el => {
        el.style.backgroundColor = cfg.primary_color;
        el.style.borderColor = cfg.primary_color;
      });

      // N√∫t secondary
      const secondaryButtons = document.querySelectorAll("#btnPrint, #btnAddColumn, #btnEditSelected, #btnCloneSelected, #btnDeleteSelected, .btn-export");
      secondaryButtons.forEach(el => {
        el.style.backgroundColor = cfg.secondary_action_color;
      });

      // Font cho to√†n b·ªô
      document.body.style.fontFamily = fontStack;

      // Font size base
      document.documentElement.style.fontSize = baseSize + "px";

      // T√πy ch·ªânh k√≠ch th∆∞·ªõc c√°c ph·∫ßn ch√≠nh d·ª±a tr√™n base
      const title = document.getElementById("appTitle");
      if (title) {
        title.style.fontSize = (baseSize * 1.6) + "px";
      }

      const tabButtons = document.querySelectorAll("nav button.tab-btn");
      tabButtons.forEach(btn => {
        btn.style.fontSize = (baseSize * 0.9) + "px";
      });

      const bodyTexts = document.querySelectorAll("main, table, input, select, button, label, p, span");
      bodyTexts.forEach(el => {
        if (!el.dataset.fixedSize) {
          el.style.fontSize = baseSize + "px";
        }
      });

      // VƒÉn b·∫£n c√≥ th·ªÉ ch·ªânh trong edit panel
      const cfgAppTitle = cfg.app_title || defaultConfig.app_title;
      const cfgProductTabTitle = cfg.product_tab_title || defaultConfig.product_tab_title;
      const cfgColumnTabTitle = cfg.column_tab_title || defaultConfig.column_tab_title;
      const cfgDashboardTabTitle = cfg.dashboard_tab_title || defaultConfig.dashboard_tab_title;

      const appTitleEl = document.getElementById("appTitle");
      if (appTitleEl) appTitleEl.textContent = cfgAppTitle;

      const tabButtonsArr = Array.from(tabButtons);
      tabButtonsArr.forEach(btn => {
        const tab = btn.getAttribute("data-tab");
        if (tab === "products") btn.textContent = cfgProductTabTitle;
        if (tab === "columns") btn.textContent = cfgColumnTabTitle;
        if (tab === "dashboard") btn.textContent = cfgDashboardTabTitle;
      });
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          applyConfigToUI(config);
        },
        mapToCapabilities: (config) => {
          const cfg = config || defaultConfig;
          return {
            recolorables: [
              {
                get: () => cfg.background_color || defaultConfig.background_color,
                set: (value) => {
                  cfg.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => cfg.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  cfg.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => cfg.text_color || defaultConfig.text_color,
                set: (value) => {
                  cfg.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => cfg.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  cfg.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  cfg.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => cfg.font_family || defaultConfig.font_family,
              set: (value) => {
                cfg.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => cfg.font_size || defaultConfig.font_size,
              set: (value) => {
                cfg.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          };
        },
        mapToEditPanelValues: (config) => {
          const cfg = config || defaultConfig;
          return new Map([
            ["app_title", cfg.app_title || defaultConfig.app_title],
            ["product_tab_title", cfg.product_tab_title || defaultConfig.product_tab_title],
            ["column_tab_title", cfg.column_tab_title || defaultConfig.column_tab_title],
            ["dashboard_tab_title", cfg.dashboard_tab_title || defaultConfig.dashboard_tab_title]
          ]);
        }
      });
      // √Åp config m·∫∑c ƒë·ªãnh l√∫c ƒë·∫ßu
      applyConfigToUI(window.elementSdk.config || defaultConfig);
    } else {
      // fallback khi kh√¥ng ch·∫°y trong Canva
      applyConfigToUI(defaultConfig);
    }

    // ================= D·ªÆ LI·ªÜU V√Ä C·∫§U TR√öC =====================
    const columnTypes = [
      "text",
      "number",
      "image",
      "richtext",
      "date",
      "datetime",
      "time",
      "email",
      "phone",
      "url",
      "color",
      "checkbox",
      "select",
      "multiselect",
      "rating",
      "currency",
      "percentage",
      "barcode",
      "qrcode",
      "tags"
    ];

    const columnTypeMeta = {
      text: { label: "VƒÉn b·∫£n", icon: "üî§" },
      number: { label: "S·ªë", icon: "üî¢" },
      image: { label: "H√¨nh ·∫£nh", icon: "üñº" },
      richtext: { label: "Rich Text", icon: "üìù" },
      date: { label: "Ng√†y", icon: "üìÖ" },
      datetime: { label: "Ng√†y & Gi·ªù", icon: "‚è∞" },
      time: { label: "Gi·ªù", icon: "‚è±" },
      email: { label: "Email", icon: "‚úâ" },
      phone: { label: "ƒêi·ªán tho·∫°i", icon: "üìû" },
      url: { label: "URL", icon: "üîó" },
      color: { label: "M√†u", icon: "üé®" },
      checkbox: { label: "Checkbox", icon: "‚òë" },
      select: { label: "Select", icon: "‚¨á" },
      multiselect: { label: "Multi Select", icon: "‚úÖ" },
      rating: { label: "ƒê√°nh gi√°", icon: "‚≠ê" },
      currency: { label: "Ti·ªÅn t·ªá", icon: "üíµ" },
      percentage: { label: "Ph·∫ßn trƒÉm", icon: "%" },
      barcode: { label: "Barcode", icon: "üè∑" },
      qrcode: { label: "QR Code", icon: "üî≥" },
      tags: { label: "Tags", icon: "üè∑" }
    };

    // C·ªôt h·ªá th·ªëng l√∫c ƒë·∫ßu
    let columns = [
      { id: "name", name: "T√™n s·∫£n ph·∫©m", type: "text", defaultValue: "", width: 180 },
      { id: "category", name: "Danh m·ª•c", type: "select", defaultValue: "", width: 120 },
      { id: "price", name: "Gi√° b√°n", type: "currency", defaultValue: 0, width: 100 },
      { id: "stock", name: "T·ªìn kho", type: "number", defaultValue: 0, width: 80 },
      { id: "images", name: "H√¨nh ·∫£nh", type: "image", defaultValue: "", width: 120 },
      { id: "createdAt", name: "Ng√†y t·∫°o", type: "datetime", defaultValue: "", width: 140 },
      { id: "updatedAt", name: "Ng√†y s·ª≠a", type: "datetime", defaultValue: "", width: 140 }
    ];

    // D·ªØ li·ªáu s·∫£n ph·∫©m
    let products = [];
    let currentEditingId = null;
    let currentPage = 1;
    let pageSize = 10;
    let sortState = { columnId: null, direction: null }; // asc/desc
    let searchKeyword = "";
    let searchColumn = "all";
    let statusFilter = "all";
    let selectedIds = new Set();
    let contextMenuProductId = null;

    // ================= TI·ªÜN √çCH =====================

    function uuid() {
      return "p_" + Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function formatDateTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleString("vi-VN");
    }

    function formatCurrency(v) {
      const n = Number(v) || 0;
      return n.toLocaleString("vi-VN", { style: "currency", currency: "VND" });
    }

    function formatPercentage(v) {
      const n = Number(v) || 0;
      return n.toFixed(2) + "%";
    }

    function getStockStatus(product) {
      const col = columns.find(c => c.id === "stock");
      const stockVal = Number(product[col.id] ?? 0);
      if (stockVal <= 0) return "out";
      if (stockVal <= 5) return "low";
      return "in";
    }

    function stockStatusLabel(status) {
      if (status === "out") return "H·∫øt h√†ng";
      if (status === "low") return "S·∫Øp h·∫øt";
      return "C√≤n h√†ng";
    }

    function stockStatusClass(status) {
      if (status === "out") return "bg-rose-500/20 text-rose-200 border border-rose-400/60";
      if (status === "low") return "bg-amber-500/20 text-amber-200 border border-amber-400/60";
      return "bg-emerald-500/20 text-emerald-200 border border-emerald-400/60";
    }

    function deepClone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function downloadFile(name, content, mime) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function timestamp() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }

    // ================== RENDER C·ªòT =======================
    const productHeaderRow = document.getElementById("productHeaderRow");
    const productBody = document.getElementById("productBody");
    const emptyState = document.getElementById("emptyState");
    const selectSearchColumn = document.getElementById("selectSearchColumn");
    const columnBody = document.getElementById("columnBody");
    const selectedCountEl = document.getElementById("selectedCount");
    const pageInfoEl = document.getElementById("pageInfo");

    function renderColumnsHeader() {
      // X√≥a t·∫•t c·∫£ c√°c c·ªôt c≈© (gi·ªØ l·∫°i ch·ªâ √¥ checkbox ƒë·∫ßu ti√™n)
      const checkboxTh = productHeaderRow.children[0];
      productHeaderRow.innerHTML = "";
      productHeaderRow.appendChild(checkboxTh);
      
      // ƒê·∫£m b·∫£o checkbox th c√≥ class sticky
      checkboxTh.className = "px-2 py-2 border-b border-sky-700 w-8 sticky-checkbox bg-sky-900";
      
      // Render header theo columns
      columns.forEach((col) => {
        const th = document.createElement("th");
        th.className = "px-2 py-2 border-b border-sky-700 text-left text-xs font-semibold whitespace-nowrap bg-sky-900";
        th.style.minWidth = col.width + "px";
        th.dataset.columnId = col.id;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "flex items-center gap-1 group";
        btn.title = col.name;
        btn.dataset.columnId = col.id;

        const spanName = document.createElement("span");
        spanName.className = "truncate max-w-[140px]";
        spanName.textContent = col.name;

        const badge = document.createElement("span");
        badge.className = "px-1.5 py-0.5 rounded-full bg-sky-800 text-[0.6rem] uppercase tracking-wide";
        const meta = columnTypeMeta[col.type] || { label: col.type, icon: "" };
        badge.textContent = meta.icon + " " + meta.label;

        const sortIndicator = document.createElement("span");
        sortIndicator.className = "text-[0.6rem] opacity-0 group-hover:opacity-60";
        sortIndicator.textContent = "‚Üï";
        sortIndicator.dataset.sortIndicator = col.id;

        btn.appendChild(spanName);
        btn.appendChild(badge);
        btn.appendChild(sortIndicator);

        th.appendChild(btn);
        productHeaderRow.appendChild(th);
      });

      // C·∫≠p nh·∫≠t select search theo c·ªôt
      selectSearchColumn.innerHTML = `<option value="all">T√¨m trong t·∫•t c·∫£ c·ªôt</option>`;
      columns.forEach(col => {
        const opt = document.createElement("option");
        opt.value = col.id;
        opt.textContent = col.name;
        selectSearchColumn.appendChild(opt);
      });

      // B·∫Øt s·ª± ki·ªán sort
      productHeaderRow.querySelectorAll("button[data-column-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          const colId = btn.dataset.columnId;
          if (sortState.columnId === colId) {
            sortState.direction = sortState.direction === "asc" ? "desc" : sortState.direction === "desc" ? null : "asc";
          } else {
            sortState.columnId = colId;
            sortState.direction = "asc";
          }
          updateSortIndicators();
          renderProducts();
        });
      });
    }

    function updateSortIndicators() {
      document.querySelectorAll("[data-sort-indicator]").forEach(el => {
        const cid = el.dataset.sortIndicator;
        if (cid === sortState.columnId && sortState.direction) {
          el.textContent = sortState.direction === "asc" ? "‚ñ≤" : "‚ñº";
          el.classList.remove("opacity-0");
        } else {
          el.textContent = "‚Üï";
          el.classList.add("opacity-0");
        }
      });
    }

    function renderColumnManagement() {
      columnBody.innerHTML = "";
      columns.forEach((col, index) => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-sky-800";

        const tdIndex = document.createElement("td");
        tdIndex.className = "px-2 py-1";
        tdIndex.innerHTML = `
          <div class="flex items-center gap-1">
            <button type="button" class="btnMoveUp px-1 py-0.5 rounded bg-slate-800" data-index="${index}" aria-label="L√™n">‚Üë</button>
            <button type="button" class="btnMoveDown px-1 py-0.5 rounded bg-slate-800" data-index="${index}" aria-label="Xu·ªëng">‚Üì</button>
            <span class="text-slate-200 text-xs">${index + 1}</span>
          </div>
        `;

        const tdName = document.createElement("td");
        tdName.className = "px-2 py-1";
        tdName.innerHTML = `
          <input type="text" class="w-full px-1 py-0.5 rounded bg-sky-950 border border-sky-700 text-xs columnNameInput" data-index="${index}" value="${col.name}" title="${col.name}" />
        `;

        const tdType = document.createElement("td");
        tdType.className = "px-2 py-1 whitespace-nowrap";
        const meta = columnTypeMeta[col.type] || { label: col.type, icon: "" };
        tdType.innerHTML = `
          <div class="flex items-center gap-1">
            <span class="text-lg">${meta.icon}</span>
            <select class="px-1 py-0.5 rounded bg-sky-950 border border-sky-700 text-xs columnTypeSelect" data-index="${index}">
              ${columnTypes.map(t => {
                const m = columnTypeMeta[t];
                const label = m ? (m.icon + " " + m.label) : t;
                const sel = t === col.type ? "selected" : "";
                return `<option value="${t}" ${sel}>${label}</option>`;
              }).join("")}
            </select>
          </div>
        `;

        const tdDefault = document.createElement("td");
        tdDefault.className = "px-2 py-1";
        let defaultControl = "";
        if (col.type === "checkbox") {
          const checked = col.defaultValue ? "checked" : "";
          defaultControl = `<input type="checkbox" class="columnDefaultCheckbox" data-index="${index}" ${checked} />`;
        } else if (col.type === "color") {
          defaultControl = `<input type="color" class="columnDefaultInput w-16 h-6" data-index="${index}" value="${col.defaultValue || "#ffffff"}" />`;
        } else {
          defaultControl = `<input type="text" class="w-full px-1 py-0.5 rounded bg-sky-950 border border-sky-700 text-xs columnDefaultInput" data-index="${index}" value="${col.defaultValue ?? ""}" />`;
        }
        tdDefault.innerHTML = defaultControl;

        const tdAction = document.createElement("td");
        tdAction.className = "px-2 py-1";
        tdAction.innerHTML = `
          <button type="button" class="btnDeleteColumn px-2 py-1 rounded bg-rose-600 text-xs" data-index="${index}">
            X√≥a
          </button>
        `;

        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdType);
        tr.appendChild(tdDefault);
        tr.appendChild(tdAction);
        columnBody.appendChild(tr);
      });

      // S·ª± ki·ªán move
      columnBody.querySelectorAll(".btnMoveUp").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.dataset.index);
          if (idx <= 0) return;
          const temp = columns[idx];
          columns[idx] = columns[idx - 1];
          columns[idx - 1] = temp;
          renderColumnsHeader();
          renderColumnManagement();
          renderProducts();
        });
      });
      columnBody.querySelectorAll(".btnMoveDown").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.dataset.index);
          if (idx >= columns.length - 1) return;
          const temp = columns[idx];
          columns[idx] = columns[idx + 1];
          columns[idx + 1] = temp;
          renderColumnsHeader();
          renderColumnManagement();
          renderProducts();
        });
      });

      // S·ª± ki·ªán ƒë·ªïi t√™n
      columnBody.querySelectorAll(".columnNameInput").forEach(input => {
        input.addEventListener("change", () => {
          const idx = Number(input.dataset.index);
          columns[idx].name = input.value.trim() || `C·ªôt ${idx + 1}`;
          renderColumnsHeader();
          renderProducts();
        });
      });

      // S·ª± ki·ªán ƒë·ªïi lo·∫°i
      columnBody.querySelectorAll(".columnTypeSelect").forEach(sel => {
        sel.addEventListener("change", () => {
          const idx = Number(sel.dataset.index);
          columns[idx].type = sel.value;
          renderColumnsHeader();
          renderColumnManagement();
          renderProducts();
        });
      });

      // S·ª± ki·ªán default value
      columnBody.querySelectorAll(".columnDefaultInput").forEach(input => {
        input.addEventListener("change", () => {
          const idx = Number(input.dataset.index);
          columns[idx].defaultValue = input.value;
        });
      });
      columnBody.querySelectorAll(".columnDefaultCheckbox").forEach(chk => {
        chk.addEventListener("change", () => {
          const idx = Number(chk.dataset.index);
          columns[idx].defaultValue = chk.checked;
        });
      });

      // X√≥a c·ªôt
      columnBody.querySelectorAll(".btnDeleteColumn").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.dataset.index);
          const colId = columns[idx].id;
          columns.splice(idx, 1);
          // X√≥a d·ªØ li·ªáu t∆∞∆°ng ·ª©ng trong product
          products.forEach(p => {
            delete p[colId];
          });
          renderColumnsHeader();
          renderColumnManagement();
          renderProducts();
        });
      });
    }

    // ================== RENDER S·∫¢N PH·∫®M =======================
    function filterSearchAndSort(list) {
      let data = list.slice();

      // L·ªçc tr·∫°ng th√°i
      data = data.filter(p => {
        const st = getStockStatus(p);
        if (statusFilter === "all") return true;
        return st === statusFilter;
      });

      // T√¨m ki·∫øm
      if (searchKeyword.trim()) {
        const kw = searchKeyword.toLowerCase();
        data = data.filter(p => {
          if (searchColumn === "all") {
            return columns.some(col => {
              const val = p[col.id];
              if (val == null) return false;
              return String(val).toLowerCase().includes(kw);
            });
          } else {
            const val = p[searchColumn];
            if (val == null) return false;
            return String(val).toLowerCase().includes(kw);
          }
        });
      }

      // S·∫Øp x·∫øp
      if (sortState.columnId && sortState.direction) {
        const colId = sortState.columnId;
        const dir = sortState.direction === "asc" ? 1 : -1;
        data.sort((a, b) => {
          const va = a[colId];
          const vb = b[colId];
          if (va == null && vb == null) return 0;
          if (va == null) return -1 * dir;
          if (vb == null) return 1 * dir;
          if (!isNaN(va) && !isNaN(vb)) {
            return (Number(va) - Number(vb)) * dir;
          }
          return String(va).localeCompare(String(vb)) * dir;
        });
      }

      return data;
    }

    function paginate(data) {
      const total = data.length;
      let pageCount = 1;
      if (pageSize === "all") {
        pageCount = 1;
      } else {
        pageCount = Math.max(1, Math.ceil(total / pageSize));
      }
      if (currentPage > pageCount) currentPage = pageCount;

      let pageData;
      if (pageSize === "all") {
        pageData = data;
      } else {
        const start = (currentPage - 1) * pageSize;
        pageData = data.slice(start, start + pageSize);
      }

      pageInfoEl.textContent = pageSize === "all" ? `1 / 1` : `${currentPage} / ${pageCount}`;
      return pageData;
    }

    function renderProducts() {
      const filtered = filterSearchAndSort(products);
      const pageData = paginate(filtered);

      productBody.innerHTML = "";
      if (!filtered.length) {
        emptyState.classList.remove("hidden");
      } else {
        emptyState.classList.add("hidden");
      }

      pageData.forEach(p => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-sky-800 hover:bg-sky-800/40 cursor-pointer";
        tr.dataset.productId = p.id;

        // checkbox
        const tdChk = document.createElement("td");
        tdChk.className = "px-2 py-1 sticky-checkbox bg-sky-900/60";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "w-4 h-4 rowCheckbox";
        chk.checked = selectedIds.has(p.id);
        chk.addEventListener("click", (e) => {
          e.stopPropagation();
          if (chk.checked) selectedIds.add(p.id);
          else selectedIds.delete(p.id);
          updateSelectionInfo();
        });
        tdChk.appendChild(chk);
        tr.appendChild(tdChk);

        // c·ªôt d·ªØ li·ªáu
        columns.forEach(col => {
          const td = document.createElement("td");
          td.className = "px-2 py-1 whitespace-nowrap";
          td.dataset.columnId = col.id;

          let value = p[col.id];
          if (col.type === "currency") {
            td.textContent = formatCurrency(value);
          } else if (col.type === "percentage") {
            td.textContent = formatPercentage(value);
          } else if (col.type === "datetime" || col.type === "date") {
            td.textContent = formatDateTime(value);
          } else if (col.type === "checkbox") {
            const span = document.createElement("span");
            span.textContent = value ? "‚úî" : "";
            td.appendChild(span);
          } else if (col.type === "rating") {
            const n = Number(value) || 0;
            td.textContent = "‚òÖ".repeat(n) + "‚òÜ".repeat(Math.max(0, 5 - n));
          } else if (col.type === "image") {
            const imgs = Array.isArray(value) ? value : [];
            if (!imgs.length) {
              td.textContent = "";
            } else {
              const first = document.createElement("div");
              first.className = "w-10 h-10 rounded bg-slate-700 overflow-hidden flex items-center justify-center text-xs text-slate-200";
              first.title = "Click ƒë·ªÉ xem ·∫£nh";
              first.addEventListener("click", (e) => {
                e.stopPropagation();
                openImageModal(imgs[0]);
              });
              const imgEl = document.createElement("img");
              imgEl.src = imgs[0];
              imgEl.alt = "·∫¢nh";
              imgEl.className = "w-full h-full object-cover";
              first.appendChild(imgEl);
              td.appendChild(first);

              if (imgs.length > 1) {
                const remain = document.createElement("span");
                remain.className = "ml-1 text-[0.65rem] text-slate-200";
                remain.textContent = `+${imgs.length - 1}`;
                td.appendChild(remain);
              }
            }
          } else {
            td.textContent = value ?? "";
          }

          tr.appendChild(td);
        });

        // click tr√°i: xem/s·ª≠a chi ti·∫øt
        tr.addEventListener("click", () => {
          openProductModal("edit", p.id);
        });

        // context menu chu·ªôt ph·∫£i
        tr.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          contextMenuProductId = p.id;
          showContextMenu(e.clientX, e.clientY);
        });

        productBody.appendChild(tr);
      });

      updateSelectionInfo();
      updateDashboard();
    }

    function updateSelectionInfo() {
      selectedCountEl.textContent = selectedIds.size;
      document.getElementById("btnEditSelected").disabled = selectedIds.size === 0;
      document.getElementById("btnCloneSelected").disabled = selectedIds.size === 0;
      document.getElementById("btnDeleteSelected").disabled = selectedIds.size === 0;
    }

    // ================= DASHBOARD =====================
    const dashTotalProducts = document.getElementById("dashTotalProducts");
    const dashTotalValue = document.getElementById("dashTotalValue");
    const dashTotalStock = document.getElementById("dashTotalStock");
    const dashNewProducts = document.getElementById("dashNewProducts");
    const dashWarnings = document.getElementById("dashWarnings");
    const dashTopProducts = document.getElementById("dashTopProducts");

    function updateDashboard() {
      dashTotalProducts.textContent = products.length;

      const priceCol = columns.find(c => c.id === "price");
      const stockCol = columns.find(c => c.id === "stock");

      let totalValue = 0;
      let totalStock = 0;
      products.forEach(p => {
        const price = Number(p[priceCol?.id] ?? 0);
        const stock = Number(p[stockCol?.id] ?? 0);
        totalStock += stock;
        totalValue += price * stock;
      });

      dashTotalValue.textContent = formatCurrency(totalValue);
      dashTotalStock.textContent = totalStock;

      // S·∫£n ph·∫©m m·ªõi trong 7 ng√†y
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const createdCol = columns.find(c => c.id === "createdAt");
      const newCount = products.filter(p => {
        const d = new Date(p[createdCol?.id]);
        return d >= sevenDaysAgo;
      }).length;
      dashNewProducts.textContent = newCount;

      // C·∫£nh b√°o t·ªìn kho
      dashWarnings.innerHTML = "";
      const low = products.filter(p => getStockStatus(p) === "low");
      const out = products.filter(p => getStockStatus(p) === "out");
      if (!low.length && !out.length) {
        const p = document.createElement("p");
        p.className = "text-xs text-slate-300";
        p.textContent = "Kh√¥ng c√≥ s·∫£n ph·∫©m s·∫Øp h·∫øt ho·∫∑c h·∫øt h√†ng.";
        dashWarnings.appendChild(p);
      } else {
        low.slice(0, 20).forEach(p => {
          const div = document.createElement("div");
          div.className = "text-xs px-2 py-1 rounded bg-amber-500/10 border border-amber-400/40 mb-1";
          div.textContent = `${p.name || "Ch∆∞a ƒë·∫∑t t√™n"} - S·∫Øp h·∫øt h√†ng`;
          dashWarnings.appendChild(div);
        });
        out.slice(0, 20).forEach(p => {
          const div = document.createElement("div");
          div.className = "text-xs px-2 py-1 rounded bg-rose-500/10 border border-rose-400/40 mb-1";
          div.textContent = `${p.name || "Ch∆∞a ƒë·∫∑t t√™n"} - H·∫øt h√†ng`;
          dashWarnings.appendChild(div);
        });
      }

      // Top 10 s·∫£n ph·∫©m gi√° tr·ªã cao
      dashTopProducts.innerHTML = "";
      if (!products.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="py-2 text-center text-slate-300 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu.</td>`;
        dashTopProducts.appendChild(tr);
      } else {
        const pv = products.map(p => {
          const price = Number(p[priceCol?.id] ?? 0);
          const stock = Number(p[stockCol?.id] ?? 0);
          return { ...p, total: price * stock };
        }).sort((a, b) => b.total - a.total).slice(0, 10);

        pv.forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.className = "border-b border-sky-800";
          const price = Number(p[priceCol?.id] ?? 0);
          const stock = Number(p[stockCol?.id] ?? 0);

          tr.innerHTML = `
            <td class="py-1 pr-2">${idx + 1}</td>
            <td class="py-1 pr-2 truncate max-w-[150px]" title="${p.name || ""}">${p.name || ""}</td>
            <td class="py-1 pr-2">${formatCurrency(price)}</td>
            <td class="py-1 pr-2">${stock}</td>
            <td class="py-1 pr-2">${formatCurrency(p.total)}</td>
          `;
          dashTopProducts.appendChild(tr);
        });
      }
    }

    // ================= MODAL S·∫¢N PH·∫®M =====================
    const productModal = document.getElementById("productModal");
    const productModalTitle = document.getElementById("productModalTitle");
    const btnCloseProductModal = document.getElementById("btnCloseProductModal");
    const btnCancelProduct = document.getElementById("btnCancelProduct");
    const productForm = document.getElementById("productForm");
    const productFormFields = document.getElementById("productFormFields");
    const inputImages = document.getElementById("inputImages");
    const imagePreviewContainer = document.getElementById("imagePreviewContainer");

    let tempImagesBase64 = [];

    function buildProductFormFields(product) {
      productFormFields.innerHTML = "";

      columns.forEach(col => {
        if (col.id === "images" || col.id === "createdAt" || col.id === "updatedAt") return;
        const wrapper = document.createElement("div");

        wrapper.className = "flex flex-col gap-1";
        const label = document.createElement("label");
        label.className = "text-xs font-semibold flex items-center gap-1";
        label.htmlFor = "col_" + col.id;
        const meta = columnTypeMeta[col.type] || { label: col.type, icon: "" };
        label.innerHTML = `<span title="${col.name}">${col.name}</span><span class="text-[0.6rem] px-1 rounded-full bg-sky-800">${meta.icon} ${meta.label}</span>`;

        let control;
        const value = product ? product[col.id] : col.defaultValue ?? "";

        // Auto ch·ªçn type input theo lo·∫°i c·ªôt
        if (col.type === "text" || col.type === "richtext" || col.type === "tags") {
          const textarea = document.createElement("textarea");
          textarea.id = "col_" + col.id;
          textarea.dataset.colId = col.id;
          textarea.rows = 2;
          textarea.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          textarea.value = value ?? "";
          control = textarea;
        } else if (col.type === "number" || col.type === "currency" || col.type === "percentage" || col.type === "rating") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "number";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          input.value = value ?? "";
          control = input;
        } else if (col.type === "date") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "date";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          if (value) {
            const d = new Date(value);
            if (!Number.isNaN(d)) {
              input.valueAsDate = d;
            }
          }
          control = input;
        } else if (col.type === "datetime") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "datetime-local";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          control = input;
        } else if (col.type === "time") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "time";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          control = input;
        } else if (col.type === "email") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "email";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          input.value = value ?? "";
          control = input;
        } else if (col.type === "phone") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "tel";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          input.value = value ?? "";
          control = input;
        } else if (col.type === "url") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "url";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          input.value = value ?? "";
          control = input;
        } else if (col.type === "color") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "color";
          input.className = "w-16 h-8 bg-sky-950 border border-sky-700 rounded";
          input.value = value || "#ffffff";
          control = input;
        } else if (col.type === "checkbox") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "checkbox";
          input.className = "w-4 h-4";
          input.checked = !!value;
          control = input;
        } else if (col.type === "select") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "text";
          input.placeholder = "Nh·∫≠p gi√° tr·ªã (v√≠ d·ª•: ƒêi·ªán tho·∫°i, Laptop...)";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          input.value = value ?? "";
          control = input;
        } else if (col.type === "multiselect") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "text";
          input.placeholder = "Nh·∫≠p nhi·ªÅu gi√° tr·ªã, c√°ch nhau b·ªüi d·∫•u ph·∫©y";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          input.value = Array.isArray(value) ? value.join(", ") : (value ?? "");
          control = input;
        } else if (col.type === "barcode" || col.type === "qrcode") {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "text";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          input.value = value ?? "";
          control = input;
        } else {
          const input = document.createElement("input");
          input.id = "col_" + col.id;
          input.dataset.colId = col.id;
          input.type = "text";
          input.className = "w-full px-2 py-1 rounded bg-sky-950 border border-sky-700 text-xs";
          input.value = value ?? "";
          control = input;
        }

        wrapper.appendChild(label);
        wrapper.appendChild(control);
        productFormFields.appendChild(wrapper);
      });
    }

    function validateFieldValue(type, value) {
      if (type === "email" && value) {
        const re = /\S+@\S+\.\S+/;
        return re.test(value);
      }
      if (type === "number" || type === "currency" || type === "percentage" || type === "rating") {
        if (value === "" || value == null) return true;
        return !isNaN(value);
      }
      if (type === "url" && value) {
        return value.startsWith("http://") || value.startsWith("https://");
      }
      return true;
    }

    function openProductModal(mode, productId) {
      currentEditingId = null;
      tempImagesBase64 = [];
      imagePreviewContainer.innerHTML = "";

      let product = null;
      if (mode === "edit" && productId) {
        product = products.find(p => p.id === productId);
        currentEditingId = productId;
        productModalTitle.textContent = "S·ª≠a s·∫£n ph·∫©m";
        const imgs = Array.isArray(product.images) ? product.images : [];
        tempImagesBase64 = imgs.slice();
        imgs.forEach((src, idx) => {
          const div = document.createElement("div");
          div.className = "w-16 h-16 rounded bg-slate-800 overflow-hidden flex items-center justify-center relative";
          const img = document.createElement("img");
          img.src = src;
          img.alt = "·∫¢nh";
          img.className = "w-full h-full object-cover";
          div.appendChild(img);
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "absolute top-0 right-0 text-[0.6rem] bg-black/60 px-1";
          removeBtn.textContent = "x";
          removeBtn.addEventListener("click", () => {
            tempImagesBase64.splice(idx, 1);
            openProductModal("edit", productId);
          });
          div.appendChild(removeBtn);
          imagePreviewContainer.appendChild(div);
        });
      } else {
        productModalTitle.textContent = "Th√™m s·∫£n ph·∫©m";
      }

      buildProductFormFields(product);
      productModal.classList.remove("hidden");
    }

    function closeProductModal() {
      productModal.classList.add("hidden");
      currentEditingId = null;
      tempImagesBase64 = [];
      imagePreviewContainer.innerHTML = "";
      productForm.reset();
    }

    btnCloseProductModal.addEventListener("click", closeProductModal);
    btnCancelProduct.addEventListener("click", closeProductModal);

    // Upload nhi·ªÅu ·∫£nh, preview, l∆∞u base64
    inputImages.addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      let loaded = 0;
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(ev) {
          const base64 = ev.target.result;
          tempImagesBase64.push(base64);
          const div = document.createElement("div");
          div.className = "w-16 h-16 rounded bg-slate-800 overflow-hidden flex items-center justify-center relative";
          const img = document.createElement("img");
          img.src = base64;
          img.alt = "·∫¢nh";
          img.className = "w-full h-full object-cover";
          div.appendChild(img);
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "absolute top-0 right-0 text-[0.6rem] bg-black/60 px-1";
          removeBtn.textContent = "x";
          removeBtn.addEventListener("click", () => {
            const idx = tempImagesBase64.indexOf(base64);
            if (idx >= 0) tempImagesBase64.splice(idx, 1);
            div.remove();
          });
          div.appendChild(removeBtn);
          imagePreviewContainer.appendChild(div);
          loaded++;
        };
        reader.readAsDataURL(file);
      });
      inputImages.value = "";
    });

    productForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const data = {};
      let isValid = true;

      columns.forEach(col => {
        if (col.id === "images" || col.id === "createdAt" || col.id === "updatedAt") return;
        const el = productForm.querySelector("[data-col-id='" + col.id + "']");
        if (!el) return;
        let val;
        if (col.type === "checkbox") {
          val = el.checked;
        } else if (col.type === "multiselect") {
          val = el.value.split(",").map(v => v.trim()).filter(Boolean);
        } else if (col.type === "number" || col.type === "currency" || col.type === "percentage" || col.type === "rating") {
          val = el.value;
          if (val === "") val = null;
          else val = Number(val);
        } else if (col.type === "date") {
          if (el.value) {
            const d = new Date(el.value);
            val = d.toISOString();
          } else {
            val = "";
          }
        } else {
          val = el.value;
        }

        // Validation theo type
        if (!validateFieldValue(col.type, val)) {
          el.classList.add("border-rose-500");
          isValid = false;
        } else {
          el.classList.remove("border-rose-500");
        }

        data[col.id] = val;
      });

      if (!isValid) {
        return;
      }

      // L∆∞u h√¨nh ·∫£nh
      data.images = tempImagesBase64.slice();

      const now = nowIso();
      if (currentEditingId) {
        const idx = products.findIndex(p => p.id === currentEditingId);
        if (idx >= 0) {
          const old = products[idx];
          const createdCol = columns.find(c => c.id === "createdAt");
          const updatedCol = columns.find(c => c.id === "updatedAt");
          data.id = old.id;
          if (createdCol) data[createdCol.id] = old[createdCol.id] || now;
          if (updatedCol) data[updatedCol.id] = now;
          products[idx] = { ...old, ...data };
        }
      } else {
        const createdCol = columns.find(c => c.id === "createdAt");
        const updatedCol = columns.find(c => c.id === "updatedAt");
        const obj = { id: uuid(), ...data };
        if (createdCol) obj[createdCol.id] = now;
        if (updatedCol) obj[updatedCol.id] = now;
        products.push(obj);
      }

      closeProductModal();
      renderProducts();
    });

    document.getElementById("btnAddProduct").addEventListener("click", () => {
      openProductModal("add");
    });

    // ================= MODAL ·∫¢NH =====================
    const imageModal = document.getElementById("imageModal");
    const imageModalImg = document.getElementById("imageModalImg");
    const imageContainer = document.getElementById("imageContainer");
    const btnZoomIn = document.getElementById("btnZoomIn");
    const btnZoomOut = document.getElementById("btnZoomOut");
    const btnZoomReset = document.getElementById("btnZoomReset");
    const btnRotate = document.getElementById("btnRotate");
    const btnCloseImageModal = document.getElementById("btnCloseImageModal");
    const zoomPercentEl = document.getElementById("zoomPercent");

    let zoomLevel = 1;
    let rotateDeg = 0;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let dragStartTranslateX = 0;
    let dragStartTranslateY = 0;

    function applyImageTransform() {
      imageModalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel}) rotate(${rotateDeg}deg)`;
      zoomPercentEl.textContent = Math.round(zoomLevel * 100) + "%";
    }

    function openImageModal(src) {
      zoomLevel = 1;
      rotateDeg = 0;
      translateX = 0;
      translateY = 0;
      imageModalImg.src = src;
      applyImageTransform();
      imageModal.classList.remove("hidden");
    }

    function closeImageModal() {
      imageModal.classList.add("hidden");
      imageModalImg.src = "";
      isDragging = false;
    }

    btnZoomIn.addEventListener("click", () => {
      zoomLevel = Math.min(zoomLevel + 0.2, 5);
      applyImageTransform();
    });
    btnZoomOut.addEventListener("click", () => {
      zoomLevel = Math.max(zoomLevel - 0.2, 0.2);
      applyImageTransform();
    });
    btnZoomReset.addEventListener("click", () => {
      zoomLevel = 1;
      translateX = 0;
      translateY = 0;
      applyImageTransform();
    });
    btnRotate.addEventListener("click", () => {
      rotateDeg = (rotateDeg + 90) % 360;
      applyImageTransform();
    });
    btnCloseImageModal.addEventListener("click", closeImageModal);
    imageModal.addEventListener("click", (e) => {
      if (e.target === imageModal) closeImageModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (!imageModal.classList.contains("hidden")) closeImageModal();
        if (!productModal.classList.contains("hidden")) closeProductModal();
        hideContextMenu();
      }
    });

    // Zoom b·∫±ng scroll
    imageContainer.addEventListener("wheel", (e) => {
      e.preventDefault();
      const oldZoom = zoomLevel;
      if (e.deltaY < 0) {
        zoomLevel = Math.min(zoomLevel + 0.1, 5);
      } else {
        zoomLevel = Math.max(zoomLevel - 0.1, 0.2);
      }
      
      // Zoom v·ªÅ ph√≠a con tr·ªè chu·ªôt
      const rect = imageContainer.getBoundingClientRect();
      const mouseX = e.clientX - rect.left - rect.width / 2;
      const mouseY = e.clientY - rect.top - rect.height / 2;
      
      const zoomRatio = zoomLevel / oldZoom;
      translateX = mouseX + (translateX - mouseX) * zoomRatio;
      translateY = mouseY + (translateY - mouseY) * zoomRatio;
      
      applyImageTransform();
    }, { passive: false });

    // K√©o ·∫£nh b·∫±ng chu·ªôt
    imageContainer.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return; // Ch·ªâ chu·ªôt tr√°i
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      dragStartTranslateX = translateX;
      dragStartTranslateY = translateY;
      e.preventDefault();
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const deltaX = e.clientX - dragStartX;
      const deltaY = e.clientY - dragStartY;
      translateX = dragStartTranslateX + deltaX;
      translateY = dragStartTranslateY + deltaY;
      applyImageTransform();
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
    });

    // H·ªó tr·ª£ touch cho mobile
    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTranslateX = 0;
    let touchStartTranslateY = 0;

    imageContainer.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        touchStartTranslateX = translateX;
        touchStartTranslateY = translateY;
      }
    });

    imageContainer.addEventListener("touchmove", (e) => {
      if (e.touches.length === 1) {
        e.preventDefault();
        const touch = e.touches[0];
        const deltaX = touch.clientX - touchStartX;
        const deltaY = touch.clientY - touchStartY;
        translateX = touchStartTranslateX + deltaX;
        translateY = touchStartTranslateY + deltaY;
        applyImageTransform();
      }
    }, { passive: false });

    // ================= CONTEXT MENU =====================
    const contextMenu = document.getElementById("contextMenu");
    function showContextMenu(x, y) {
      contextMenu.style.left = x + "px";
      contextMenu.style.top = y + "px";
      contextMenu.classList.remove("hidden");
    }
    function hideContextMenu() {
      contextMenu.classList.add("hidden");
      contextMenuProductId = null;
    }
    document.addEventListener("click", () => {
      hideContextMenu();
    });
    contextMenu.addEventListener("click", (e) => {
      e.stopPropagation();
      const action = e.target.getAttribute("data-action");
      if (!action || !contextMenuProductId) return;
      const p = products.find(prod => prod.id === contextMenuProductId);
      if (!p) return;

      if (action === "edit") {
        openProductModal("edit", p.id);
      } else if (action === "clone") {
        cloneProducts([p.id]);
      } else if (action === "delete") {
        deleteProducts([p.id]);
      } else if (action === "export") {
        const json = JSON.stringify(p, null, 2);
        downloadFile(`product_${p.id}_${timestamp()}.json`, json, "application/json");
      }

      hideContextMenu();
    });

    // ================= X·ª¨ L√ù CH·ªåN H√ÄNG LO·∫†T =====================
    const chkSelectAll = document.getElementById("chkSelectAll");
    chkSelectAll.addEventListener("change", () => {
      selectedIds.clear();
      if (chkSelectAll.checked) {
        products.forEach(p => selectedIds.add(p.id));
      }
      renderProducts();
    });

    function cloneProducts(ids) {
      ids.forEach(id => {
        const p = products.find(prod => prod.id === id);
        if (!p) return;
        const clone = deepClone(p);
        clone.id = uuid();
        const createdCol = columns.find(c => c.id === "createdAt");
        const updatedCol = columns.find(c => c.id === "updatedAt");
        const now = nowIso();
        if (createdCol) clone[createdCol.id] = now;
        if (updatedCol) clone[updatedCol.id] = now;
        products.push(clone);
      });
      renderProducts();
    }

    function deleteProducts(ids) {
      products = products.filter(p => !ids.includes(p.id));
      ids.forEach(id => selectedIds.delete(id));
      renderProducts();
    }

    document.getElementById("btnCloneSelected").addEventListener("click", () => {
      cloneProducts(Array.from(selectedIds));
    });
    document.getElementById("btnDeleteSelected").addEventListener("click", () => {
      deleteProducts(Array.from(selectedIds));
    });
    document.getElementById("btnEditSelected").addEventListener("click", () => {
      const arr = Array.from(selectedIds);
      if (!arr.length) return;
      // ƒë∆°n gi·∫£n: s·ª≠a s·∫£n ph·∫©m ƒë·∫ßu ti√™n trong danh s√°ch ch·ªçn
      openProductModal("edit", arr[0]);
    });

    // ================= T√åM KI·∫æM, L·ªåC, PH√ÇN TRANG =====================
    const inputSearch = document.getElementById("inputSearch");
    const selectStatusFilter = document.getElementById("selectStatusFilter");
    const pageSizeSelect = document.getElementById("pageSize");
    const btnPrevPage = document.getElementById("btnPrevPage");
    const btnNextPage = document.getElementById("btnNextPage");

    inputSearch.addEventListener("input", () => {
      searchKeyword = inputSearch.value;
      currentPage = 1;
      renderProducts();
    });
    selectSearchColumn.addEventListener("change", () => {
      searchColumn = selectSearchColumn.value;
      currentPage = 1;
      renderProducts();
    });
    selectStatusFilter.addEventListener("change", () => {
      statusFilter = selectStatusFilter.value;
      currentPage = 1;
      renderProducts();
    });
    pageSizeSelect.addEventListener("change", () => {
      const val = pageSizeSelect.value;
      pageSize = val === "all" ? "all" : Number(val);
      currentPage = 1;
      renderProducts();
    });
    btnPrevPage.addEventListener("click", () => {
      if (pageSize === "all") return;
      if (currentPage > 1) {
        currentPage--;
        renderProducts();
      }
    });
    btnNextPage.addEventListener("click", () => {
      if (pageSize === "all") return;
      const filtered = filterSearchAndSort(products);
      const total = filtered.length;
      const pageCount = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage < pageCount) {
        currentPage++;
        renderProducts();
      }
    });

    // ================= XU·∫§T / NH·∫¨P =====================
    const btnExportAll = document.querySelectorAll(".btn-export");
    const inputImport = document.getElementById("inputImport");
    const importProgressBar = document.getElementById("importProgressBar");
    const importStatus = document.getElementById("importStatus");

    function collectExportData() {
      return {
        version: "1.0",
        exportedAt: nowIso(),
        columns: columns,
        products: products,
        settings: {
          pageSize,
          sortState,
          statusFilter
        }
      };
    }

    function exportTXT(dataObj) {
      const lines = [];
      lines.push(`Qu·∫£n l√Ω b√°n h√†ng - backup`);
      lines.push(`Version: ${dataObj.version}`);
      lines.push(`ExportedAt: ${dataObj.exportedAt}`);
      lines.push("");
      lines.push("COLUMNS:");
      dataObj.columns.forEach(c => {
        lines.push(`- ${c.id} | ${c.name} | ${c.type}`);
      });
      lines.push("");
      lines.push("PRODUCTS:");
      dataObj.products.forEach((p, idx) => {
        lines.push(`#${idx + 1}`);
        columns.forEach(col => {
          lines.push(`${col.name}: ${p[col.id] ?? ""}`);
        });
        lines.push("");
      });
      return lines.join("\n");
    }

    function exportCSV(dataObj) {
      const headers = columns.map(c => c.id);
      const rows = dataObj.products.map(p => {
        return headers.map(h => {
          let v = p[h];
          if (Array.isArray(v)) v = v.join("|");
          if (typeof v === "string") {
            return '"' + v.replace(/"/g, '""') + '"';
          }
          return v ?? "";
        }).join(",");
      });
      return [headers.join(","), ...rows].join("\n");
    }

    function exportHTML(dataObj) {
      const rows = dataObj.products.map(p => {
        const tds = columns.map(c => `<td>${p[c.id] ?? ""}</td>`).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      const ths = columns.map(c => `<th>${c.name}</th>`).join("");
      return `<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Export Products</title></head>
<body>
<h1>Danh s√°ch s·∫£n ph·∫©m</h1>
<table border="1" cellspacing="0" cellpadding="4">
<thead><tr>${ths}</tr></thead>
<tbody>${rows}</tbody>
</table>
</body>
</html>`;
    }

    function exportXML(dataObj) {
      const lines = [];
      lines.push(`<?xml version="1.0" encoding="UTF-8"?>`);
      lines.push(`<inventory version="${dataObj.version}" exportedAt="${dataObj.exportedAt}">`);
      lines.push(`  <columns>`);
      dataObj.columns.forEach(c => {
        lines.push(`    <column id="${c.id}" name="${c.name}" type="${c.type}"/>`);
      });
      lines.push(`  </columns>`);
      lines.push(`  <products>`);
      dataObj.products.forEach(p => {
        lines.push(`    <product id="${p.id}">`);
        columns.forEach(c => {
          let v = p[c.id];
          if (Array.isArray(v)) v = v.join("|");
          v = v == null ? "" : String(v).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
          lines.push(`      <${c.id}>${v}</${c.id}>`);
        });
        lines.push(`    </product>`);
      });
      lines.push(`  </products>`);
      lines.push(`</inventory>`);
      return lines.join("\n");
    }

    btnExportAll.forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.export;
        const dataObj = collectExportData();
        let content = "";
        let mime = "text/plain";
        let ext = type;

        if (type === "txt") {
          content = exportTXT(dataObj);
          mime = "text/plain";
        } else if (type === "json") {
          content = JSON.stringify(dataObj, null, 2);
          mime = "application/json";
        } else if (type === "csv") {
          content = exportCSV(dataObj);
          mime = "text/csv";
        } else if (type === "html") {
          content = exportHTML(dataObj);
          mime = "text/html";
        } else if (type === "xml") {
          content = exportXML(dataObj);
          mime = "application/xml";
        }

        const name = `products_${timestamp()}.${ext}`;
        downloadFile(name, content, mime);
      });
    });

    inputImport.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      importStatus.textContent = "ƒêang ƒë·ªçc file...";
      importProgressBar.style.width = "10%";

      const reader = new FileReader();
      reader.onload = function(ev) {
        const text = ev.target.result;
        importProgressBar.style.width = "50%";
        let dataObj = null;

        try {
          if (file.name.endsWith(".json")) {
            dataObj = JSON.parse(text);
          } else if (file.name.endsWith(".txt")) {
            try {
              const jsonPart = text.slice(text.indexOf("{"));
              dataObj = JSON.parse(jsonPart);
            } catch (err) {
              dataObj = null;
            }
          } else if (file.name.endsWith(".csv")) {
            // ƒë∆°n gi·∫£n: kh√¥ng kh√¥i ph·ª•c t·ª´ csv v√¨ thi·∫øu metadata
            importStatus.textContent = "CSV ch·ªâ h·ªó tr·ª£ ƒë·ªçc th√¥, kh√¥ng t·ª± map.";
          } else if (file.name.endsWith(".xml") || file.name.endsWith(".html")) {
            // demo: kh√¥ng parse chi ti·∫øt
            importStatus.textContent = "Lo·∫°i file n√†y ch·ªâ minh h·ªça, kh√¥ng kh√¥i ph·ª•c t·ª± ƒë·ªông.";
          }
        } catch (err) {
          dataObj = null;
        }

        if (!dataObj || !Array.isArray(dataObj.columns) || !Array.isArray(dataObj.products)) {
          importStatus.textContent = "File kh√¥ng h·ª£p l·ªá.";
          importProgressBar.style.width = "0%";
          return;
        }

        columns = dataObj.columns;
        products = dataObj.products;
        importProgressBar.style.width = "100%";
        importStatus.textContent = "Nh·∫≠p th√†nh c√¥ng.";
        renderColumnsHeader();
        renderColumnManagement();
        renderProducts();

        setTimeout(() => {
          importProgressBar.style.width = "0%";
          importStatus.textContent = "";
        }, 2000);
      };
      reader.readAsText(file);
      inputImport.value = "";
    });

    // ================= BACKUP / RESTORE RI√äNG =====================
    document.getElementById("btnBackup").addEventListener("click", () => {
      const dataObj = collectExportData();
      const json = JSON.stringify(dataObj, null, 2);
      downloadFile(`backup_${timestamp()}.json`, json, "application/json");
    });

    document.getElementById("inputRestore").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const dataObj = JSON.parse(ev.target.result);
          if (!Array.isArray(dataObj.columns) || !Array.isArray(dataObj.products)) return;
          columns = dataObj.columns;
          products = dataObj.products;
          renderColumnsHeader();
          renderColumnManagement();
          renderProducts();
        } catch (err) {}
      };
      reader.readAsText(file);
      e.target.value = "";
    });

    // ================= IN DANH S√ÅCH =====================
    document.getElementById("btnPrint").addEventListener("click", () => {
      const dataObj = collectExportData();
      const html = exportHTML(dataObj);
      const frame = document.getElementById("printFrame");
      const doc = frame.contentWindow || frame.contentDocument;
      const win = doc.document || doc;
      win.document.open();
      win.document.write(html);
      win.document.close();
      setTimeout(() => {
        doc.print();
      }, 500);
    });

    // ================= TAB =====================
    const tabs = document.querySelectorAll(".tab-btn");
    const tabDashboard = document.getElementById("tab-dashboard");
    const tabProducts = document.getElementById("tab-products");
    const tabSell = document.getElementById("tab-sell");
    const tabColumns = document.getElementById("tab-columns");

    function showTab(name) {
      [tabDashboard, tabProducts, tabSell, tabColumns].forEach(s => s.classList.add("hidden"));
      if (name === "dashboard") tabDashboard.classList.remove("hidden");
      if (name === "products") tabProducts.classList.remove("hidden");
      if (name === "sell") {
        tabSell.classList.remove("hidden");
        renderSellProducts();
      }
      if (name === "columns") tabColumns.classList.remove("hidden");

      tabs.forEach(btn => {
        if (btn.dataset.tab === name) {
          btn.classList.add("border-emerald-400", "text-white", "font-semibold");
          btn.classList.remove("border-transparent");
        } else {
          btn.classList.remove("border-emerald-400", "text-white", "font-semibold");
          btn.classList.add("border-transparent");
        }
      });
    }

    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        showTab(tab);
      });
    });

    // ================= B√ÅN H√ÄNG =====================
    const sellProductList = document.getElementById("sellProductList");
    const sellSearch = document.getElementById("sellSearch");
    const cartItems = document.getElementById("cartItems");
    const cartSubtotal = document.getElementById("cartSubtotal");
    const cartTotal = document.getElementById("cartTotal");
    const discountInput = document.getElementById("discountInput");
    const customerName = document.getElementById("customerName");
    const btnClearCart = document.getElementById("btnClearCart");
    const btnCheckout = document.getElementById("btnCheckout");

    let cart = []; // { productId, quantity }

    function renderSellProducts() {
      const searchTerm = (sellSearch.value || "").toLowerCase();
      const stockCol = columns.find(c => c.id === "stock");
      
      const availableProducts = products.filter(p => {
        const stock = Number(p[stockCol?.id] || 0);
        if (stock <= 0) return false;
        if (!searchTerm) return true;
        const nameCol = columns.find(c => c.id === "name");
        const name = p[nameCol?.id] || "";
        return name.toLowerCase().includes(searchTerm);
      });

      sellProductList.innerHTML = "";
      if (!availableProducts.length) {
        sellProductList.innerHTML = '<p class="text-xs text-slate-300 col-span-2 text-center py-4">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o c√≤n h√†ng</p>';
        return;
      }

      availableProducts.forEach(p => {
        const card = document.createElement("div");
        card.className = "p-2 rounded-lg bg-sky-800/40 border border-sky-700 hover:border-emerald-400 cursor-pointer transition-colors";
        
        const imgs = Array.isArray(p.images) ? p.images : [];
        const imgSrc = imgs[0] || "";
        
        const nameCol = columns.find(c => c.id === "name");
        const priceCol = columns.find(c => c.id === "price");
        const stockColVal = columns.find(c => c.id === "stock");
        
        const name = p[nameCol?.id] || "Ch∆∞a ƒë·∫∑t t√™n";
        const price = p[priceCol?.id] || 0;
        const stock = p[stockColVal?.id] || 0;
        
        card.innerHTML = `
          <div class="flex gap-2">
            ${imgSrc ? `<div class="w-12 h-12 rounded bg-slate-700 overflow-hidden flex-shrink-0">
              <img src="${imgSrc}" alt="${name}" class="w-full h-full object-cover" />
            </div>` : ''}
            <div class="flex-1 min-w-0">
              <h3 class="text-xs font-semibold truncate">${name}</h3>
              <p class="text-[0.65rem] text-slate-300">Kho: ${stock}</p>
              <p class="text-xs font-bold text-emerald-400">${formatCurrency(price)}</p>
            </div>
          </div>
        `;

        card.addEventListener("click", () => {
          addToCart(p.id);
        });

        sellProductList.appendChild(card);
      });
    }

    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const stockCol = columns.find(c => c.id === "stock");
      const stock = Number(product[stockCol?.id] || 0);
      if (stock <= 0) return;

      const existingItem = cart.find(c => c.productId === productId);
      if (existingItem) {
        if (existingItem.quantity < stock) {
          existingItem.quantity++;
        }
      } else {
        cart.push({ productId, quantity: 1 });
      }

      renderCart();
    }

    function updateCartItemQuantity(productId, newQuantity) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const stockCol = columns.find(c => c.id === "stock");
      const stock = Number(product[stockCol?.id] || 0);
      const item = cart.find(c => c.productId === productId);
      if (!item) return;

      // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng kh√¥ng v∆∞·ª£t qu√° kho
      const limitedQty = Math.max(1, Math.min(newQuantity, stock));
      item.quantity = limitedQty;

      renderCart();
    }

    function removeFromCart(productId) {
      cart = cart.filter(c => c.productId !== productId);
      renderCart();
    }

    function renderCart() {
      if (!cart.length) {
        cartItems.innerHTML = '<p class="text-xs text-slate-300 text-center py-4">Gi·ªè h√†ng tr·ªëng</p>';
        cartSubtotal.textContent = "0 ‚Ç´";
        cartTotal.textContent = "0 ‚Ç´";
        return;
      }

      let subtotal = 0;
      cartItems.innerHTML = "";

      const priceCol = columns.find(c => c.id === "price");
      const stockCol = columns.find(c => c.id === "stock");
      const nameCol = columns.find(c => c.id === "name");

      cart.forEach(item => {
        const product = products.find(p => p.id === item.productId);
        if (!product) return;

        const price = Number(product[priceCol?.id] || 0);
        const itemTotal = price * item.quantity;
        subtotal += itemTotal;
        const stock = Number(product[stockCol?.id] || 0);
        const name = product[nameCol?.id] || "Ch∆∞a ƒë·∫∑t t√™n";

        const div = document.createElement("div");
        div.className = "p-2 rounded-lg bg-sky-800/40 border border-sky-700 text-xs";
        div.innerHTML = `
          <div class="flex justify-between items-start mb-1">
            <h4 class="font-semibold flex-1 truncate">${name}</h4>
            <button class="btnRemoveCartItem text-rose-400 hover:text-rose-300 ml-2" data-product-id="${product.id}">‚úï</button>
          </div>
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-1">
              <button class="btnDecreaseQty px-1.5 py-0.5 rounded bg-slate-700 hover:bg-slate-600" data-product-id="${product.id}">-</button>
              <input type="number" min="1" max="${stock}" value="${item.quantity}" 
                class="qtyInput w-12 px-1 py-0.5 rounded bg-sky-950 border border-sky-700 text-center text-xs" 
                data-product-id="${product.id}" />
              <button class="btnIncreaseQty px-1.5 py-0.5 rounded bg-slate-700 hover:bg-slate-600" data-product-id="${product.id}">+</button>
            </div>
            <span class="font-semibold">${formatCurrency(itemTotal)}</span>
          </div>
          <div class="text-[0.65rem] text-slate-400 mt-1">ƒê∆°n gi√°: ${formatCurrency(price)} | Kho: ${stock}</div>
        `;

        cartItems.appendChild(div);
      });

      // S·ª± ki·ªán tƒÉng gi·∫£m
      cartItems.querySelectorAll(".btnDecreaseQty").forEach(btn => {
        btn.addEventListener("click", () => {
          const pid = btn.dataset.productId;
          const item = cart.find(c => c.productId === pid);
          if (item && item.quantity > 1) {
            updateCartItemQuantity(pid, item.quantity - 1);
          }
        });
      });

      cartItems.querySelectorAll(".btnIncreaseQty").forEach(btn => {
        btn.addEventListener("click", () => {
          const pid = btn.dataset.productId;
          const item = cart.find(c => c.productId === pid);
          if (item) {
            updateCartItemQuantity(pid, item.quantity + 1);
          }
        });
      });

      // S·ª± ki·ªán nh·∫≠p s·ªë l∆∞·ª£ng
      cartItems.querySelectorAll(".qtyInput").forEach(input => {
        input.addEventListener("change", () => {
          const pid = input.dataset.productId;
          const newQty = parseInt(input.value) || 1;
          updateCartItemQuantity(pid, newQty);
        });
      });

      // S·ª± ki·ªán x√≥a
      cartItems.querySelectorAll(".btnRemoveCartItem").forEach(btn => {
        btn.addEventListener("click", () => {
          removeFromCart(btn.dataset.productId);
        });
      });

      // T√≠nh t·ªïng
      const discount = Number(discountInput.value || 0);
      const discountAmount = subtotal * (discount / 100);
      const total = subtotal - discountAmount;

      cartSubtotal.textContent = formatCurrency(subtotal);
      cartTotal.textContent = formatCurrency(total);
    }

    sellSearch.addEventListener("input", renderSellProducts);
    discountInput.addEventListener("input", renderCart);

    btnClearCart.addEventListener("click", () => {
      cart = [];
      renderCart();
    });

    // ================= H√ÄM IN H√ìA ƒê∆†N M·ªöI =====================
    function printInvoiceNow(invoice) {
      const invoiceHTML = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>H√≥a ƒë∆°n ${invoice.id}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; }
    .info { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    .text-right { text-align: right; }
    .total-section { margin-top: 20px; text-align: right; }
    .total-section div { margin-bottom: 5px; }
    .grand-total { font-size: 1.3em; font-weight: bold; }
  </style>
</head>
<body>
  <h1>H√ìA ƒê∆†N B√ÅN H√ÄNG</h1>
  <div class="info">
    <p><strong>M√£ h√≥a ƒë∆°n:</strong> ${invoice.id}</p>
    <p><strong>Kh√°ch h√†ng:</strong> ${invoice.customerName}</p>
    <p><strong>Ng√†y:</strong> ${formatDateTime(invoice.date)}</p>
  </div>
  <table>
    <thead>
      <tr>
        <th>STT</th>
        <th>S·∫£n ph·∫©m</th>
        <th class="text-right">ƒê∆°n gi√°</th>
        <th class="text-right">S·ªë l∆∞·ª£ng</th>
        <th class="text-right">Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody>
      ${invoice.items.map((item, index) => `
      <tr>
        <td>${index + 1}</td>
        <td>${item.productName}</td>
        <td class="text-right">${formatCurrency(item.price)}</td>
        <td class="text-right">${item.quantity}</td>
        <td class="text-right">${formatCurrency(item.total)}</td>
      </tr>`).join('')}
    </tbody>
  </table>
  <div class="total-section">
    <div><strong>T·∫°m t√≠nh:</strong> ${formatCurrency(invoice.subtotal)}</div>
    <div><strong>Gi·∫£m gi√° (${invoice.discount}%):</strong> -${formatCurrency(invoice.discountAmount)}</div>
    <div class="grand-total"><strong>T·ªïng c·ªông:</strong> ${formatCurrency(invoice.total)}</div>
  </div>
  <p style="text-align: center; margin-top: 30px; font-style: italic;">C·∫£m ∆°n qu√Ω kh√°ch!</p>
</body>
</html>`;

      const frame = document.getElementById("printFrame");
      const frameDoc = frame.contentWindow || frame.contentDocument;
      
      if (frameDoc.document) {
        frameDoc.document.open();
        frameDoc.document.write(invoiceHTML);
        frameDoc.document.close();
        
        setTimeout(() => {
          try {
            frameDoc.print();
          } catch (err) {
            console.error("L·ªói khi in:", err);
          }
        }, 500);
      } else {
        // Fallback
        const win = frameDoc;
        win.document.open();
        win.document.write(invoiceHTML);
        win.document.close();
        
        setTimeout(() => {
          try {
            win.print();
          } catch (err) {
            console.error("L·ªói khi in:", err);
          }
        }, 500);
      }
    }

    // ================= THANH TO√ÅN - ƒê√É S·ª¨A =====================
    btnCheckout.addEventListener("click", (e) => {
      e.preventDefault();
      
      if (!cart.length) {
        const msg = document.createElement("div");
        msg.className = "fixed top-4 right-4 bg-rose-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm";
        msg.textContent = "Gi·ªè h√†ng tr·ªëng!";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2000);
        return;
      }

      // T√¨m c·ªôt stock, price, name
      const stockCol = columns.find(c => c.id === "stock");
      const priceCol = columns.find(c => c.id === "price");
      const nameCol = columns.find(c => c.id === "name");
      
      if (!stockCol) {
        const msg = document.createElement("div");
        msg.className = "fixed top-4 right-4 bg-rose-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm";
        msg.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y c·ªôt t·ªìn kho!";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2000);
        return;
      }

      // TR·ª™ KHO - S·ª¨A L·∫†I ƒê·ªÇ TRUY C·∫¨P ƒê√öNG C·ªòT
      cart.forEach(item => {
        const product = products.find(p => p.id === item.productId);
        if (product) {
          const currentStock = Number(product[stockCol.id] || 0);
          product[stockCol.id] = Math.max(0, currentStock - item.quantity);
          const updatedCol = columns.find(c => c.id === "updatedAt");
          if (updatedCol) {
            product[updatedCol.id] = nowIso();
          }
        }
      });

      // T·∫°o h√≥a ƒë∆°n ƒë·ªÉ in
      const customerNameValue = customerName.value.trim() || "Kh√°ch v√£ng lai";
      const discount = Number(discountInput.value || 0);
      let subtotal = 0;
      
      const invoiceItems = cart.map(item => {
        const product = products.find(p => p.id === item.productId);
        if (!product) return null;
        const price = Number(product[priceCol?.id] || 0);
        const itemTotal = price * item.quantity;
        subtotal += itemTotal;
        return {
          productName: product[nameCol?.id] || "Ch∆∞a ƒë·∫∑t t√™n",
          price: price,
          quantity: item.quantity,
          total: itemTotal
        };
      }).filter(Boolean);

      const discountAmount = subtotal * (discount / 100);
      const total = subtotal - discountAmount;

      const invoice = {
        id: "INV_" + Date.now(),
        date: nowIso(),
        customerName: customerNameValue,
        items: invoiceItems,
        subtotal: subtotal,
        discount: discount,
        discountAmount: discountAmount,
        total: total
      };

      // IN H√ìA ƒê∆†N
      printInvoiceNow(invoice);

      // Th√¥ng b√°o th√†nh c√¥ng
      const msg = document.createElement("div");
      msg.className = "fixed top-4 right-4 bg-emerald-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm";
      msg.textContent = "‚úì Thanh to√°n th√†nh c√¥ng! ƒê√£ tr·ª´ kho v√† in h√≥a ƒë∆°n.";
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 3000);

      // X√≥a gi·ªè
      cart = [];
      customerName.value = "";
      discountInput.value = "0";
      renderCart();
      renderProducts();
      renderSellProducts();
    });

    // ================= TH√äM C·ªòT M·ªöI =====================
    document.getElementById("btnAddColumn").addEventListener("click", () => {
      const id = "col" + (columns.length + 1);
      columns.push({
        id,
        name: "C·ªôt m·ªõi " + (columns.length + 1),
        type: "text",
        defaultValue: "",
        width: 120
      });
      renderColumnsHeader();
      renderColumnManagement();
      renderProducts();
    });

    // ================= KH·ªûI T·∫†O =====================
    renderColumnsHeader();
    renderColumnManagement();
    renderProducts();
    showTab("products");
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b416b1a407d6e4c',t:'MTc2Njc2MDkxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
