<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω B√°n h√†ng N√¢ng cao</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: none;
            background: transparent;
            font-size: 16px;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-filter-bar input, .search-filter-bar select {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px auto;
            display: none;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }

        th .sort-icon {
            margin-left: 5px;
            font-size: 12px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .product-image:hover {
            transform: scale(1.1);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .cart-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: right;
        }

        .cart-total h3 {
            font-size: 2em;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .product-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .product-card:hover {
            transform: scale(1.05);
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .product-card h4 {
            margin: 10px 0;
            color: #333;
        }

        .product-card .price {
            color: #667eea;
            font-size: 1.3em;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 30px;
            cursor: pointer;
            color: #6c757d;
        }

        .close:hover {
            color: #dc3545;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control button {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 5px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }

        .quantity-control input {
            width: 60px;
            text-align: center;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            padding: 5px;
        }

        .custom-field {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .custom-field .remove-field {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        /* Image Viewer Modal */
        .image-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-modal.active {
            display: flex;
        }

        .image-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-viewer-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            transition: transform 0.3s;
        }

        .image-viewer-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .image-viewer-controls button {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .image-viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .toolbar {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí H·ªá th·ªëng Qu·∫£n l√Ω B√°n h√†ng N√¢ng cao</h1>
            <p>Qu·∫£n l√Ω s·∫£n ph·∫©m v·ªõi h√¨nh ·∫£nh, t√πy ch·ªânh c·ªôt v√† xu·∫•t/nh·∫≠p d·ªØ li·ªáu</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('sales')">üí∞ B√°n h√†ng</button>
            <button class="tab" onclick="switchTab('products')">üì¶ S·∫£n ph·∫©m</button>
            <button class="tab" onclick="switchTab('orders')">üìã ƒê∆°n h√†ng</button>
            <button class="tab" onclick="switchTab('reports')">üìä B√°o c√°o</button>
            <button class="tab" onclick="switchTab('columns')">‚öôÔ∏è Qu·∫£n l√Ω c·ªôt</button>
        </div>

        <!-- Tab B√°n h√†ng -->
        <div id="sales" class="tab-content active">
            <div class="grid">
                <div>
                    <div class="search-box">
                        <input type="text" id="productSearch" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..." oninput="searchProducts()">
                    </div>
                    <div class="product-grid" id="productList"></div>
                </div>
                <div>
                    <h2>üõçÔ∏è Gi·ªè h√†ng</h2>
                    <div id="cart"></div>
                    <div class="cart-total">
                        <p>T·ªïng c·ªông:</p>
                        <h3 id="cartTotal">0 ‚Ç´</h3>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="completeSale()" style="width: 100%;">‚úÖ Ho√†n t·∫•t thanh to√°n</button>
                        <button class="btn btn-danger" onclick="clearCart()" style="width: 100%; margin-top: 10px;">üóëÔ∏è X√≥a gi·ªè h√†ng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab S·∫£n ph·∫©m -->
        <div id="products" class="tab-content">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showAddProductModal()">‚ûï Th√™m s·∫£n ph·∫©m</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Xu·∫•t Excel</button>
                <button class="btn btn-success" onclick="exportToJSON()">üìÑ Xu·∫•t JSON</button>
                <button class="btn btn-info" onclick="importFromJSON()">üì• Nh·∫≠p JSON</button>
                <button class="btn btn-info" onclick="exportToTXT()">üìù Xu·∫•t TXT</button>
            </div>
            
            <div class="search-filter-bar">
                <input type="text" id="productTableSearch" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..." oninput="filterProductTable()">
                <select id="categoryFilter" onchange="filterProductTable()">
                    <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                </select>
            </div>

            <div class="table-container">
                <table id="productTable">
                    <thead>
                        <tr id="productTableHeader"></tr>
                    </thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab ƒê∆°n h√†ng -->
        <div id="orders" class="tab-content">
            <h2>üìã Danh s√°ch ƒë∆°n h√†ng</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>M√£ ƒêH</th>
                            <th>Ng√†y</th>
                            <th>S·ªë l∆∞·ª£ng SP</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="orderTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab B√°o c√°o -->
        <div id="reports" class="tab-content">
            <h2>üìä B√°o c√°o th·ªëng k√™</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalRevenue">0 ‚Ç´</h3>
                    <p>T·ªïng doanh thu</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalOrders">0</h3>
                    <p>T·ªïng ƒë∆°n h√†ng</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalProducts">0</h3>
                    <p>T·ªïng s·∫£n ph·∫©m</p>
                </div>
                <div class="stat-card">
                    <h3 id="lowStock">0</h3>
                    <p>S·∫£n ph·∫©m s·∫Øp h·∫øt</p>
                </div>
            </div>
            
            <h3>üìà S·∫£n ph·∫©m b√°n ch·∫°y nh·∫•t</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>S·ªë l∆∞·ª£ng ƒë√£ b√°n</th>
                            <th>Doanh thu</th>
                        </tr>
                    </thead>
                    <tbody id="topProductsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab Qu·∫£n l√Ω c·ªôt -->
        <div id="columns" class="tab-content">
            <h2>‚öôÔ∏è Qu·∫£n l√Ω c·ªôt t√πy ch·ªânh</h2>
            <p style="margin-bottom: 20px; color: #6c757d;">Th√™m, x√≥a ho·∫∑c ·∫©n/hi·ªán c√°c c·ªôt trong b·∫£ng s·∫£n ph·∫©m</p>
            
            <div class="card">
                <h3>Th√™m c·ªôt m·ªõi</h3>
                <div class="form-group">
                    <label>T√™n c·ªôt *</label>
                    <input type="text" id="newColumnName" placeholder="V√≠ d·ª•: Nh√† cung c·∫•p, Xu·∫•t x·ª©...">
                </div>
                <div class="form-group">
                    <label>Lo·∫°i d·ªØ li·ªáu *</label>
                    <select id="newColumnType">
                        <option value="text">Ch·ªØ</option>
                        <option value="number">S·ªë</option>
                        <option value="image">H√¨nh ·∫£nh</option>
                        <option value="textarea">VƒÉn b·∫£n d√†i</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addCustomColumn()">‚ûï Th√™m c·ªôt</button>
            </div>

            <h3 style="margin-top: 30px;">Danh s√°ch c·ªôt hi·ªán t·∫°i</h3>
            <div id="customColumnsList"></div>
        </div>
    </div>

    <!-- Modal th√™m/s·ª≠a s·∫£n ph·∫©m -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            <div id="productFormFields"></div>
            <button class="btn btn-primary" onclick="saveProduct()">üíæ L∆∞u s·∫£n ph·∫©m</button>
        </div>
    </div>

    <!-- Modal chi ti·∫øt ƒë∆°n h√†ng -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>
                <span class="close" onclick="closeOrderModal()">&times;</span>
            </div>
            <div id="orderDetails"></div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageViewerModal" class="image-viewer-modal">
        <div class="image-viewer-content">
            <button class="image-viewer-close" onclick="closeImageViewer()">√ó</button>
            <img id="viewerImage" src="" alt="Image">
            <div class="image-viewer-controls">
                <button onclick="zoomImage(-0.2)">üîç- Zoom Out</button>
                <button onclick="zoomImage(0.2)">üîç+ Zoom In</button>
                <button onclick="resetZoom()">‚Ü∫ Reset</button>
            </div>
        </div>
    </div>

    <script>
        // Kh·ªüi t·∫°o d·ªØ li·ªáu
        let products = [];
        let cart = [];
        let orders = [];
        let editingProductId = null;
        let sortColumn = null;
        let sortDirection = 'asc';
        let imageZoom = 1;
        
        // C·∫•u tr√∫c c·ªôt m·∫∑c ƒë·ªãnh
        let columns = [
            { id: 'id', name: 'M√£ SP', type: 'text', system: true, visible: true },
            { id: 'image', name: 'H√¨nh ·∫£nh', type: 'image', system: true, visible: true },
            { id: 'name', name: 'T√™n s·∫£n ph·∫©m', type: 'text', system: true, visible: true },
            { id: 'category', name: 'Danh m·ª•c', type: 'text', system: true, visible: true },
            { id: 'price', name: 'Gi√° b√°n', type: 'number', system: true, visible: true },
            { id: 'stock', name: 'T·ªìn kho', type: 'number', system: true, visible: true },
            { id: 'description', name: 'M√¥ t·∫£', type: 'textarea', system: true, visible: true }
        ];

        // Image storage (simulated)
        const imageStorage = {};

        // Load d·ªØ li·ªáu m·∫´u
        function loadData() {
            const defaultImage = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect width="200" height="200" fill="%23667eea"/%3E%3Ctext x="50%25" y="50%25" font-size="60" text-anchor="middle" dy=".3em" fill="white"%3Eüì¶%3C/text%3E%3C/svg%3E';
            
            products = [
                { id: 1, name: 'iPhone 15 Pro', category: 'ƒêi·ªán tho·∫°i', price: 29990000, stock: 15, description: 'Smartphone cao c·∫•p', image: defaultImage },
                { id: 2, name: 'Samsung Galaxy S24', category: 'ƒêi·ªán tho·∫°i', price: 24990000, stock: 20, description: 'Flagship Android', image: defaultImage },
                { id: 3, name: 'MacBook Pro M3', category: 'Laptop', price: 45990000, stock: 8, description: 'Laptop chuy√™n nghi·ªáp', image: defaultImage },
                { id: 4, name: 'AirPods Pro', category: 'Ph·ª• ki·ªán', price: 6990000, stock: 30, description: 'Tai nghe kh√¥ng d√¢y', image: defaultImage },
                { id: 5, name: 'iPad Air', category: 'M√°y t√≠nh b·∫£ng', price: 16990000, stock: 12, description: 'M√°y t√≠nh b·∫£ng ƒëa nƒÉng', image: defaultImage }
            ];
        }

        loadData();

        // Chuy·ªÉn tab
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'products') {
                updateCategoryFilter();
                renderProductTable();
            }
            if (tabName === 'orders') renderOrderTable();
            if (tabName === 'reports') updateReports();
            if (tabName === 'sales') renderProductList();
            if (tabName === 'columns') renderCustomColumnsList();
        }

        // ƒê·ªãnh d·∫°ng ti·ªÅn
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        // Image Viewer Functions
        function openImageViewer(imageSrc) {
            document.getElementById('viewerImage').src = imageSrc;
            document.getElementById('imageViewerModal').classList.add('active');
            imageZoom = 1;
            document.getElementById('viewerImage').style.transform = `scale(${imageZoom})`;
        }

        function closeImageViewer() {
            document.getElementById('imageViewerModal').classList.remove('active');
        }

        function zoomImage(delta) {
            imageZoom += delta;
            if (imageZoom < 0.5) imageZoom = 0.5;
            if (imageZoom > 3) imageZoom = 3;
            document.getElementById('viewerImage').style.transform = `scale(${imageZoom})`;
        }

        function resetZoom() {
            imageZoom = 1;
            document.getElementById('viewerImage').style.transform = `scale(${imageZoom})`;
        }

        // Hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m (POS)
        function renderProductList() {
            const container = document.getElementById('productList');
            if (products.length === 0) {
                container.innerHTML = '<div class="no-data">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</div>';
                return;
            }
            container.innerHTML = products.map(p => `
                <div class="product-card" onclick="addToCart(${p.id})">
                    ${p.image ? `<img src="${p.image}" alt="${p.name}" onclick="event.stopPropagation(); openImageViewer('${p.image}')">` : ''}
                    <h4>${p.name}</h4>
                    <div class="price">${formatMoney(p.price)}</div>
                    <div class="stock">C√≤n: ${p.stock}</div>
                </div>
            `).join('');
        }

        // T√¨m ki·∫øm s·∫£n ph·∫©m (POS)
        function searchProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.category.toLowerCase().includes(search)
            );
            
            const container = document.getElementById('productList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="no-data">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>';
                return;
            }
            container.innerHTML = filtered.map(p => `
                <div class="product-card" onclick="addToCart(${p.id})">
                    ${p.image ? `<img src="${p.image}" alt="${p.name}" onclick="event.stopPropagation(); openImageViewer('${p.image}')">` : ''}
                    <h4>${p.name}</h4>
                    <div class="price">${formatMoney(p.price)}</div>
                    <div class="stock">C√≤n: ${p.stock}</div>
                </div>
            `).join('');
        }

        // Th√™m v√†o gi·ªè h√†ng
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                alert('‚ö†Ô∏è S·∫£n ph·∫©m kh√¥ng ƒë·ªß h√†ng!');
                return;
            }

            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    alert('‚ö†Ô∏è Kh√¥ng ƒë·ªß h√†ng trong kho!');
                    return;
                }
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            renderCart();
        }

        // Hi·ªÉn th·ªã gi·ªè h√†ng
        function renderCart() {
            const container = document.getElementById('cart');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (cart.length === 0) {
                container.innerHTML = '<div class="no-data">Gi·ªè h√†ng tr·ªëng</div>';
            } else {
                container.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${formatMoney(item.price)} x ${item.quantity}</small>
                        </div>
                        <div class="quantity-control">
                            <button onclick="updateCartQuantity(${item.id}, -1)">-</button>
                            <input type="number" value="${item.quantity}" readonly>
                            <button onclick="updateCartQuantity(${item.id}, 1)">+</button>
                            <button class="btn btn-danger" onclick="removeFromCart(${item.id})" style="width: auto; padding: 8px 12px; margin: 0;">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('cartTotal').textContent = formatMoney(total);
        }

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng
        function updateCartQuantity(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (cartItem) {
                const newQuantity = cartItem.quantity + change;
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else if (newQuantity <= product.stock) {
                    cartItem.quantity = newQuantity;
                    renderCart();
                } else {
                    alert('‚ö†Ô∏è Kh√¥ng ƒë·ªß h√†ng trong kho!');
                }
            }
        }

        // X√≥a kh·ªèi gi·ªè h√†ng
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
        }

        // X√≥a gi·ªè h√†ng
        function clearCart() {
            if (cart.length === 0) {
                alert('‚ö†Ô∏è Gi·ªè h√†ng ƒë√£ tr·ªëng!');
                return;
            }
            if (confirm('üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?')) {
                cart = [];
                renderCart();
            }
        }

        // Ho√†n t·∫•t b√°n h√†ng
        function completeSale() {
            if (cart.length === 0) {
                alert('‚ö†Ô∏è Gi·ªè h√†ng tr·ªëng!');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const order = {
                id: orders.length + 1,
                date: new Date().toLocaleString('vi-VN'),
                items: [...cart],
                total: total
            };

            // C·∫≠p nh·∫≠t t·ªìn kho
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.stock -= item.quantity;
                }
            });

            orders.push(order);
            alert(`‚úÖ ƒê∆°n h√†ng #${order.id} ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!\nT·ªïng ti·ªÅn: ${formatMoney(total)}`);
            
            cart = [];
            renderCart();
            renderProductList();
        }

        // C·∫≠p nh·∫≠t filter danh m·ª•c
        function updateCategoryFilter() {
            const categories = [...new Set(products.map(p => p.category))];
            const filter = document.getElementById('categoryFilter');
            filter.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>' + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // L·ªçc v√† t√¨m ki·∫øm s·∫£n ph·∫©m trong b·∫£ng
        function filterProductTable() {
            const searchText = document.getElementById('productTableSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filtered = products.filter(p => {
                const matchSearch = p.name.toLowerCase().includes(searchText) || 
                                  p.category.toLowerCase().includes(searchText) ||
                                  (p.description && p.description.toLowerCase().includes(searchText));
                const matchCategory = !categoryFilter || p.category === categoryFilter;
                return matchSearch && matchCategory;
            });

            renderProductTable(filtered);
        }

        // S·∫Øp x·∫øp b·∫£ng
        function sortTable(columnId) {
            if (sortColumn === columnId) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnId;
                sortDirection = 'asc';
            }

            products.sort((a, b) => {
                let aVal = a[columnId];
                let bVal = b[columnId];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderProductTable();
        }

        // Hi·ªÉn th·ªã b·∫£ng s·∫£n ph·∫©m
        function renderProductTable(productList = products) {
            const visibleColumns = columns.filter(col => col.visible);
            
            // Render header
            const header = document.getElementById('productTableHeader');
            header.innerHTML = visibleColumns.map(col => `
                <th onclick="sortTable('${col.id}')">
                    ${col.name}
                    ${sortColumn === col.id ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                </th>
            `).join('') + '<th style="background: #6c757d;">Thao t√°c</th>';

            // Render body
            const tbody = document.getElementById('productTableBody');
            if (productList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleColumns.length + 1}" class="no-data">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</td></tr>`;
                return;
            }

            tbody.innerHTML = productList.map(p => `
                <tr>
                    ${visibleColumns.map(col => {
                        let value = p[col.id];
                        if (col.id === 'id') {
                            return `<td>SP${String(value).padStart(3, '0')}</td>`;
                        } else if (col.type === 'image') {
                            return `<td>${value ? `<img src="${value}" class="product-image" onclick="openImageViewer('${value}')">` : 'üì¶'}</td>`;
                        } else if (col.type === 'number') {
                            if (col.id === 'price') {
                                return `<td>${formatMoney(value || 0)}</td>`;
                            } else if (col.id === 'stock') {
                                return `<td style="color: ${value < 10 ? '#dc3545' : '#28a745'}; font-weight: bold;">${value || 0}</td>`;
                            }
                            return `<td>${value || 0}</td>`;
                        } else {
                            return `<td>${value || '-'}</td>`;
                        }
                    }).join('')}
                    <td>
                        <button class="btn btn-warning" onclick="editProduct(${p.id})" style="padding: 8px 16px;">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${p.id})" style="padding: 8px 16px;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Render form s·∫£n ph·∫©m
        function renderProductForm() {
            const container = document.getElementById('productFormFields');
            const product = editingProductId ? products.find(p => p.id === editingProductId) : null;

            container.innerHTML = columns.filter(col => col.id !== 'id' && col.visible).map(col => {
                const value = product ? product[col.id] : '';
                
                if (col.type === 'image') {
                    return `
                        <div class="form-group">
                            <label>${col.name}</label>
                            <div class="image-upload-area" onclick="document.getElementById('imageInput_${col.id}').click()">
                                <p>üì∑ Click ƒë·ªÉ ch·ªçn h√¨nh ·∫£nh</p>
                                <input type="file" id="imageInput_${col.id}" accept="image/*" style="display: none;" onchange="handleImageUpload(event, '${col.id}')">
                            </div>
                            <div class="image-preview" id="preview_${col.id}" style="${value ? 'display: block;' : ''}">
                                ${value ? `<img src="${value}" alt="Preview" onclick="openImageViewer('${value}')">` : ''}
                            </div>
                            <input type="hidden" id="field_${col.id}" value="${value || ''}">
                        </div>
                    `;
                } else if (col.type === 'textarea') {
                    return `
                        <div class="form-group">
                            <label>${col.name}</label>
                            <textarea id="field_${col.id}" rows="3">${value || ''}</textarea>
                        </div>
                    `;
                } else if (col.type === 'number') {
                    return `
                        <div class="form-group">
                            <label>${col.name} ${col.system ? '*' : ''}</label>
                            <input type="number" id="field_${col.id}" value="${value || ''}" ${col.system ? 'required' : ''}>
                        </div>
                    `;
                } else {
                    return `
                        <div class="form-group">
                            <label>${col.name} ${col.system ? '*' : ''}</label>
                            <input type="text" id="field_${col.id}" value="${value || ''}" ${col.system ? 'required' : ''}>
                        </div>
                    `;
                }
            }).join('');
        }

        // X·ª≠ l√Ω upload ·∫£nh (l∆∞u d∆∞·ªõi d·∫°ng Base64)
        function handleImageUpload(event, fieldId) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                
                // L∆∞u v√†o imageStorage (gi·∫£ l·∫≠p th∆∞ m·ª•c)
                const imageName = `img_${Date.now()}_${file.name}`;
                imageStorage[imageName] = base64;
                
                document.getElementById(`field_${fieldId}`).value = base64;
                const preview = document.getElementById(`preview_${fieldId}`);
                preview.style.display = 'block';
                preview.innerHTML = `<img src="${base64}" alt="Preview" onclick="openImageViewer('${base64}')">`;
            };
            reader.readAsDataURL(file);
        }

        // Modal s·∫£n ph·∫©m
        function showAddProductModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
            renderProductForm();
            document.getElementById('productModal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function editProduct(id) {
            editingProductId = id;
            document.getElementById('modalTitle').textContent = 'S·ª≠a s·∫£n ph·∫©m';
            renderProductForm();
            document.getElementById('productModal').classList.add('active');
        }

        function saveProduct() {
            const productData = {};
            
            // Thu th·∫≠p d·ªØ li·ªáu t·ª´ form
            columns.forEach(col => {
                if (col.id === 'id') return;
                const field = document.getElementById(`field_${col.id}`);
                if (field) {
                    if (col.type === 'number') {
                        productData[col.id] = parseFloat(field.value) || 0;
                    } else {
                        productData[col.id] = field.value;
                    }
                }
            });

            // Validate c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
            const nameCol = columns.find(c => c.id === 'name');
            const categoryCol = columns.find(c => c.id === 'category');
            const priceCol = columns.find(c => c.id === 'price');
            const stockCol = columns.find(c => c.id === 'stock');

            if (nameCol && nameCol.visible && !productData.name) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m!');
                return;
            }

            if (categoryCol && categoryCol.visible && !productData.category) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p danh m·ª•c!');
                return;
            }

            if (priceCol && priceCol.visible && (!productData.price || productData.price <= 0)) {
                alert('‚ö†Ô∏è Gi√° b√°n ph·∫£i l·ªõn h∆°n 0!');
                return;
            }

            if (stockCol && stockCol.visible && (productData.stock === undefined || productData.stock < 0)) {
                alert('‚ö†Ô∏è S·ªë l∆∞·ª£ng t·ªìn kho kh√¥ng ƒë∆∞·ª£c √¢m!');
                return;
            }

            if (editingProductId) {
                const product = products.find(p => p.id === editingProductId);
                Object.assign(product, productData);
                alert('‚úÖ C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!');
            } else {
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({ id: newId, ...productData });
                alert('‚úÖ Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!');
            }

            closeProductModal();
            renderProductTable();
            renderProductList();
            updateCategoryFilter();
        }

        function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            if (confirm(`üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m "${product.name}"?`)) {
                products = products.filter(p => p.id !== id);
                renderProductTable();
                renderProductList();
                alert('‚úÖ ƒê√£ x√≥a s·∫£n ph·∫©m!');
            }
        }

        // Qu·∫£n l√Ω c·ªôt t√πy ch·ªânh
        function addCustomColumn() {
            const name = document.getElementById('newColumnName').value.trim();
            const type = document.getElementById('newColumnType').value;

            if (!name) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n c·ªôt!');
                return;
            }

            // T·∫°o ID t·ª´ t√™n c·ªôt
            const id = 'custom_' + name.toLowerCase().replace(/[^a-z0-9]/g, '_');

            // Ki·ªÉm tra tr√πng
            if (columns.find(col => col.id === id)) {
                alert('‚ö†Ô∏è C·ªôt n√†y ƒë√£ t·ªìn t·∫°i!');
                return;
            }

            columns.push({
                id: id,
                name: name,
                type: type,
                system: false,
                visible: true
            });

            // Th√™m field v√†o t·∫•t c·∫£ s·∫£n ph·∫©m
            products.forEach(p => {
                p[id] = type === 'number' ? 0 : '';
            });

            document.getElementById('newColumnName').value = '';
            alert('‚úÖ ƒê√£ th√™m c·ªôt m·ªõi!');
            renderCustomColumnsList();
            renderProductTable();
        }

        function removeCustomColumn(columnId) {
            const column = columns.find(col => col.id === columnId);
            if (confirm(`üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c·ªôt "${column.name}"?\n\nL∆∞u √Ω: D·ªØ li·ªáu trong c·ªôt n√†y s·∫Ω b·ªã m·∫•t vƒ©nh vi·ªÖn!`)) {
                columns = columns.filter(col => col.id !== columnId);
                
                // X√≥a data t·ª´ products
                products.forEach(p => {
                    delete p[columnId];
                });

                alert('‚úÖ ƒê√£ x√≥a c·ªôt!');
                renderCustomColumnsList();
                renderProductTable();
            }
        }

        function toggleColumnVisibility(columnId) {
            const column = columns.find(col => col.id === columnId);
            column.visible = !column.visible;
            renderCustomColumnsList();
            renderProductTable();
        }

        function renderCustomColumnsList() {
            const container = document.getElementById('customColumnsList');
            
            const systemCols = columns.filter(col => col.system);
            const customCols = columns.filter(col => !col.system);

            container.innerHTML = `
                <h4 style="margin-top: 20px;">üìå C·ªôt h·ªá th·ªëng</h4>
                <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">C√°c c·ªôt n√†y c√≥ th·ªÉ b·ªã x√≥a ho·∫∑c ·∫©n theo nhu c·∫ßu</p>
                ${systemCols.map(col => `
                    <div class="custom-field">
                        <strong>${col.name}</strong> 
                        <span style="color: #6c757d;">(${col.type})</span>
                        <button class="remove-field" onclick="removeCustomColumn('${col.id}')" title="X√≥a c·ªôt">√ó</button>
                        <button class="btn ${col.visible ? 'btn-success' : 'btn-warning'}" 
                                onclick="toggleColumnVisibility('${col.id}')"
                                style="float: right; padding: 5px 15px; margin-right: 35px;">
                            ${col.visible ? 'üëÅÔ∏è Hi·ªán' : 'üö´ ·∫®n'}
                        </button>
                    </div>
                `).join('')}

                <h4 style="margin-top: 20px;">‚úèÔ∏è C·ªôt t√πy ch·ªânh</h4>
                ${customCols.length === 0 ? '<p style="color: #6c757d;">Ch∆∞a c√≥ c·ªôt t√πy ch·ªânh n√†o</p>' : ''}
                ${customCols.map(col => `
                    <div class="custom-field">
                        <strong>${col.name}</strong> 
                        <span style="color: #6c757d;">(${col.type})</span>
                        <button class="remove-field" onclick="removeCustomColumn('${col.id}')" title="X√≥a c·ªôt">√ó</button>
                        <button class="btn ${col.visible ? 'btn-success' : 'btn-warning'}" 
                                onclick="toggleColumnVisibility('${col.id}')"
                                style="float: right; padding: 5px 15px; margin-right: 35px;">
                            ${col.visible ? 'üëÅÔ∏è Hi·ªán' : 'üö´ ·∫®n'}
                        </button>
                    </div>
                `).join('')}
            `;
        }

        // Xu·∫•t Excel
        function exportToExcel() {
            if (products.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ xu·∫•t!');
                return;
            }

            const visibleColumns = columns.filter(col => col.visible);
            
            // T·∫°o workbook
            const wb = XLSX.utils.book_new();
            
            // T·∫°o data cho sheet
            const wsData = [];
            
            // Header
            wsData.push(visibleColumns.map(col => col.name));
            
            // Data rows
            products.forEach(p => {
                const row = visibleColumns.map(col => {
                    if (col.id === 'id') {
                        return 'SP' + String(p.id).padStart(3, '0');
                    } else if (col.type === 'image') {
                        return p[col.id] ? 'C√≥ h√¨nh ·∫£nh' : 'Kh√¥ng c√≥';
                    } else if (col.id === 'price') {
                        return p.price;
                    } else {
                        return p[col.id] || '';
                    }
                });
                wsData.push(row);
            });

            // T·∫°o worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Set column widths
            ws['!cols'] = visibleColumns.map(col => {
                if (col.type === 'image') return { wch: 15 };
                if (col.type === 'textarea') return { wch: 30 };
                return { wch: 20 };
            });

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'S·∫£n ph·∫©m');

            // Xu·∫•t file
            XLSX.writeFile(wb, `san_pham_${Date.now()}.xlsx`);
            alert('‚úÖ Xu·∫•t Excel th√†nh c√¥ng!');
        }

        // Xu·∫•t JSON (bao g·ªìm ·∫£nh d∆∞·ªõi d·∫°ng Base64)
        function exportToJSON() {
            const data = {
                products: products,
                orders: orders,
                columns: columns,
                imageStorage: imageStorage,
                exportDate: new Date().toLocaleString('vi-VN'),
                version: '2.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pos_data_${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Xu·∫•t JSON th√†nh c√¥ng!\n\nFile bao g·ªìm:\n- Danh s√°ch s·∫£n ph·∫©m\n- ƒê∆°n h√†ng\n- C·∫•u h√¨nh c·ªôt\n- H√¨nh ·∫£nh (Base64)');
        }

        // Xu·∫•t TXT
        function exportToTXT() {
            if (products.length === 0) {
                alert('‚ö†Ô∏è Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ xu·∫•t!');
                return;
            }

            const visibleColumns = columns.filter(col => col.visible);
            let txtContent = '========================================\n';
            txtContent += '   H·ªÜ TH·ªêNG QU·∫¢N L√ù B√ÅN H√ÄNG\n';
            txtContent += '   DANH S√ÅCH S·∫¢N PH·∫®M\n';
            txtContent += `   Ng√†y xu·∫•t: ${new Date().toLocaleString('vi-VN')}\n`;
            txtContent += '========================================\n\n';

            products.forEach((p, index) => {
                txtContent += `[${index + 1}] S·∫£n ph·∫©m: ${p.name || 'N/A'}\n`;
                txtContent += '-'.repeat(40) + '\n';
                
                visibleColumns.forEach(col => {
                    if (col.id === 'id') {
                        txtContent += `${col.name}: SP${String(p.id).padStart(3, '0')}\n`;
                    } else if (col.type === 'image') {
                        txtContent += `${col.name}: ${p[col.id] ? 'C√≥ h√¨nh ·∫£nh' : 'Kh√¥ng c√≥'}\n`;
                    } else if (col.id === 'price') {
                        txtContent += `${col.name}: ${formatMoney(p.price || 0)}\n`;
                    } else {
                        txtContent += `${col.name}: ${p[col.id] || '-'}\n`;
                    }
                });
                
                txtContent += '\n';
            });

            txtContent += '========================================\n';
            txtContent += `T·ªïng s·ªë s·∫£n ph·∫©m: ${products.length}\n`;
            txtContent += '========================================\n';

            const txtBlob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(txtBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `san_pham_${Date.now()}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Xu·∫•t TXT th√†nh c√¥ng!');
        }

        // Nh·∫≠p JSON
        function importFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.products || !Array.isArray(data.products)) {
                            alert('‚ö†Ô∏è File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!');
                            return;
                        }

                        // Confirm tr∆∞·ªõc khi import
                        if (!confirm(`üì• Nh·∫≠p d·ªØ li·ªáu t·ª´ file?\n\n- S·∫£n ph·∫©m: ${data.products.length}\n- ƒê∆°n h√†ng: ${data.orders ? data.orders.length : 0}\n- C·ªôt t√πy ch·ªânh: ${data.columns ? data.columns.length : 0}\n\nD·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®!`)) {
                            return;
                        }

                        products = data.products;
                        
                        if (data.orders && Array.isArray(data.orders)) {
                            orders = data.orders;
                        }
                        
                        if (data.columns && Array.isArray(data.columns)) {
                            columns = data.columns;
                        }

                        if (data.imageStorage) {
                            Object.assign(imageStorage, data.imageStorage);
                        }

                        renderProductTable();
                        renderProductList();
                        renderOrderTable();
                        updateReports();
                        updateCategoryFilter();
                        renderCustomColumnsList();
                        
                        alert('‚úÖ Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!');
                    } catch (error) {
                        alert('‚ö†Ô∏è L·ªói khi ƒë·ªçc file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Hi·ªÉn th·ªã ƒë∆°n h√†ng
        function renderOrderTable() {
            const tbody = document.getElementById('orderTable');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                return;
            }
            tbody.innerHTML = orders.slice().reverse().map(o => `
                <tr>
                    <td>DH${String(o.id).padStart(3, '0')}</td>
                    <td>${o.date}</td>
                    <td>${o.items.reduce((sum, item) => sum + item.quantity, 0)}</td>
                    <td>${formatMoney(o.total)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewOrder(${o.id})" style="padding: 8px 16px;">üëÅÔ∏è Xem</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${o.id})" style="padding: 8px 16px;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewOrder(id) {
            const order = orders.find(o => o.id === id);
            const details = document.getElementById('orderDetails');
            details.innerHTML = `
                <p><strong>M√£ ƒë∆°n h√†ng:</strong> DH${String(order.id).padStart(3, '0')}</p>
                <p><strong>Ng√†y:</strong> ${order.date}</p>
                <hr style="margin: 15px 0;">
                <h3>S·∫£n ph·∫©m:</h3>
                ${order.items.map(item => `
                    <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>${item.name}</strong><br>
                        <small>${formatMoney(item.price)} x ${item.quantity} = <strong>${formatMoney(item.price * item.quantity)}</strong></small>
                    </div>
                `).join('')}
                <hr style="margin: 15px 0;">
                <h3 style="color: #667eea;">T·ªïng c·ªông: ${formatMoney(order.total)}</h3>
                <button class="btn btn-primary" onclick="printOrder(${order.id})" style="margin-top: 20px; width: 100%;">üñ®Ô∏è In h√≥a ƒë∆°n</button>
            `;
            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        function deleteOrder(id) {
            if (confirm('üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng n√†y?')) {
                orders = orders.filter(o => o.id !== id);
                renderOrderTable();
                updateReports();
                alert('‚úÖ ƒê√£ x√≥a ƒë∆°n h√†ng!');
            }
        }

        function printOrder(id) {
            const order = orders.find(o => o.id === id);
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>H√≥a ƒë∆°n #DH${String(order.id).padStart(3, '0')}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #667eea; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #667eea; padding-bottom: 20px; }
                        .info { margin: 20px 0; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background: #667eea; color: white; }
                        .total { text-align: right; font-size: 1.5em; font-weight: bold; margin-top: 20px; color: #667eea; }
                        .footer { text-align: center; margin-top: 50px; color: #666; border-top: 2px solid #667eea; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üõí H√ìA ƒê∆†N B√ÅN H√ÄNG</h1>
                        <p>H·ªá th·ªëng Qu·∫£n l√Ω B√°n h√†ng</p>
                    </div>
                    <div class="info">
                        <p><strong>M√£ ƒë∆°n h√†ng:</strong> DH${String(order.id).padStart(3, '0')}</p>
                        <p><strong>Ng√†y:</strong> ${order.date}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.name}</td>
                                    <td>${formatMoney(item.price)}</td>
                                    <td>${item.quantity}</td>
                                    <td>${formatMoney(item.price * item.quantity)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="total">
                        T·ªîNG C·ªòNG: ${formatMoney(order.total)}
                    </div>
                    <div class="footer">
                        <p><strong>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ mua h√†ng!</strong></p>
                        <p>H·∫πn g·∫∑p l·∫°i qu√Ω kh√°ch!</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // C·∫≠p nh·∫≠t b√°o c√°o
        function updateReports() {
            const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);
            const totalOrdersCount = orders.length;
            const totalProductsCount = products.length;
            const lowStockCount = products.filter(p => p.stock < 10).length;

            document.getElementById('totalRevenue').textContent = formatMoney(totalRevenue);
            document.getElementById('totalOrders').textContent = totalOrdersCount;
            document.getElementById('totalProducts').textContent = totalProductsCount;
            document.getElementById('lowStock').textContent = lowStockCount;

            // Top s·∫£n ph·∫©m b√°n ch·∫°y
            const productSales = {};
            orders.forEach(order => {
                order.items.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productSales[item.id].quantity += item.quantity;
                    productSales[item.id].revenue += item.price * item.quantity;
                });
            });

            const topProducts = Object.values(productSales)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);

            const topProductsTable = document.getElementById('topProductsTable');
            if (topProducts.length === 0) {
                topProductsTable.innerHTML = '<tr><td colspan="3" class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            } else {
                topProductsTable.innerHTML = topProducts.map(p => `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.quantity}</td>
                        <td>${formatMoney(p.revenue)}</td>
                    </tr>
                `).join('');
            }
        }

        // Kh·ªüi t·∫°o h·ªá th·ªëng
        function initSystem() {
            renderProductList();
            renderProductTable();
            renderOrderTable();
            updateReports();
            renderCart();
            updateCategoryFilter();
            renderCustomColumnsList();
            
            console.log('‚úÖ H·ªá th·ªëng POS N√¢ng cao ƒë√£ s·∫µn s√†ng!');
            console.log('üì¶ S·∫£n ph·∫©m:', products.length);
            console.log('üìã ƒê∆°n h√†ng:', orders.length);
            console.log('‚öôÔ∏è C·ªôt t√πy ch·ªânh:', columns.length);
        }

        // Kh·ªüi ƒë·ªông
        initSystem();

        // Auto-save v√† c·∫£nh b√°o
        setInterval(() => {
            const lowStockProducts = products.filter(p => p.stock < 10 && p.stock > 0);
            if (lowStockProducts.length > 0) {
                console.warn('‚ö†Ô∏è C·∫£nh b√°o: C√≥', lowStockProducts.length, 's·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng');
            }
        }, 60000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S: L∆∞u (prevent default save)
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportToJSON();
            }
            
            // ESC: ƒê√≥ng modal
            if (e.key === 'Escape') {
                closeProductModal();
                closeOrderModal();
                closeImageViewer();
            }
        });

        // Click outside modal to close
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductModal();
            }
        });

        document.getElementById('orderModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOrderModal();
            }
        });

        document.getElementById('imageViewerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageViewer();
            }
        });

        // Prevent right-click on images (optional)
        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'IMG' && e.target.classList.contains('product-image')) {
                e.preventDefault();
            }
        });

        console.log(`
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë   üõí H·ªÜ TH·ªêNG QU·∫¢N L√ù B√ÅN H√ÄNG N√ÇNG CAO           ‚ïë
        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
        ‚ïë   ‚úÖ Qu·∫£n l√Ω s·∫£n ph·∫©m v·ªõi h√¨nh ·∫£nh (Base64)        ‚ïë
        ‚ïë   ‚úÖ T√¨m ki·∫øm v√† s·∫Øp x·∫øp th√¥ng minh                 ‚ïë
        ‚ïë   ‚úÖ Xem ·∫£nh to v√† zoom                             ‚ïë
        ‚ïë   ‚úÖ Th√™m/x√≥a c·ªôt t√πy ch·ªânh (k·ªÉ c·∫£ c·ªôt h·ªá th·ªëng)   ‚ïë
        ‚ïë   ‚úÖ Xu·∫•t d·ªØ li·ªáu: Excel, JSON, TXT                 ‚ïë
        ‚ïë   ‚úÖ Nh·∫≠p d·ªØ li·ªáu t·ª´ JSON                           ‚ïë
        ‚ïë   ‚úÖ Qu·∫£n l√Ω ƒë∆°n h√†ng v√† b√°o c√°o                    ‚ïë
        ‚ïë   ‚úÖ Keyboard shortcuts (Ctrl+S, ESC)              ‚ïë
        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
        ‚ïë   üí° Ph√≠m t·∫Øt:                                      ‚ïë
        ‚ïë      - Ctrl + S: Xu·∫•t d·ªØ li·ªáu JSON                 ‚ïë
        ‚ïë      - ESC: ƒê√≥ng modal                              ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `);
    </script>
</body>
</html>